<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendario de Cajas Recicladas</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .wrap{ max-width:1100px; margin:0 auto; padding:0 12px; }
    .head{ display:flex; align-items:center; justify-content:flex-start; gap:10px; margin:14px 0; }
    .cal-bar{ display:flex; align-items:center; gap:10px; }
    .btn{ background:#0d8e8a; color:#fff; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; }
    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; }
    .dow{ text-align:center; opacity:.8; font-weight:700; }
    .cell{
      min-height:90px; background:#0f2533; border-radius:12px; padding:8px; box-shadow:0 6px 18px rgba(0,0,0,.25);
      display:flex; flex-direction:column; justify-content:space-between; border:2px solid rgba(255,255,255,.08);
    }
    .date{ opacity:.85; font-weight:700; }
    .total{ text-align:right; font-size:18px; font-weight:800; color:#25b7a7; }
    .foot{ margin-top:14px; display:flex; justify-content:flex-end; gap:16px; }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html"><img src="img/logo.png" alt="Logo"></a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" onclick="history.back()">VOLVER</button>
</header>

<main class="wrap">
  <div class="head">
    <div class="cal-bar">
      <button class="btn" id="prev">◀︎</button>
      <h2 id="title" style="margin:0"></h2>
      <button class="btn" id="next">▶︎</button>
    </div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="foot">
    <button class="btn" onclick="location.href='index.html'">Ir al inicio</button>
  </div>
</main>

<script type="module" src="firebase-config.js"></script>
<script type="module">
  import { db } from "./firebase-config.js";
  import { collectionGroup, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const title = document.getElementById("title");
  const grid  = document.getElementById("grid");

  const DOW = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];

  function ymd(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function monthBounds(y, m){ // m: 0..11
    const from = new Date(y, m, 1);
    const to   = new Date(y, m+1, 0);
    return { from, to };
  }

  let cur = new Date();
  cur.setDate(1);

  async function render(){
    const y = cur.getFullYear(), m = cur.getMonth();
    const { from, to } = monthBounds(y,m);
    title.textContent = from.toLocaleDateString("es-MX", { month:"long", year:"numeric" });

    grid.innerHTML = "";
    // encabezados
    for (const d of DOW){
      const h = document.createElement("div");
      h.className = "dow";
      h.textContent = d;
      grid.appendChild(h);
    }

    // Traer todos los docs de boxes_days (sin filtros ni índices) y filtrar por rango en cliente
    const snap = await getDocs(collectionGroup(db, "boxes_days"));
    const perDay = new Map(); // "YYYY-MM-DD" -> total

    snap.forEach(doc=>{
      const data = doc.data() || {};
      const day  = String(data.dateKey || "");
      if (!day) return;
      const dt = new Date(day);
      if (Number.isNaN(dt.getTime())) return;
      if (dt >= new Date(y, m, 1) && dt <= new Date(y, m+1, 0)){
        perDay.set(day, (perDay.get(day)||0) + Number(data.total||0));
      }
    });

    // celdas vacías antes del 1 (ajustando con lunes como inicio)
    const firstDow = (from.getDay()+6)%7; // 0=lunes
    for (let i=0;i<firstDow;i++){
      const e = document.createElement("div"); e.className="cell"; grid.appendChild(e);
    }

    // días del mes
    for (let d=1; d<=to.getDate(); d++){
      const dd = new Date(y,m,d);
      const key = ymd(dd);
      const total = perDay.get(key)||0;

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.innerHTML = `
        <div class="date">${d}</div>
        <div class="total">${total.toLocaleString("es-MX")}</div>
      `;
      grid.appendChild(cell);
    }
  }

  document.getElementById("prev").onclick = ()=>{ cur.setMonth(cur.getMonth()-1); render(); };
  document.getElementById("next").onclick = ()=>{ cur.setMonth(cur.getMonth()+1); render(); };

  render().catch(err=>{
    console.error("Error al cargar calendario:", err);
    grid.innerHTML = "<div style='grid-column:1/-1; opacity:.8'>No se pudo cargar el calendario.</div>";
  });
</script>
</body>
</html>
