<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plan de hoy</title>

  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style-modelos.css"/>

  <style>
    .wrap {max-width: 1200px; margin: 0 auto; padding: 0 12px;}
    .plan-toolbar {display:flex; gap:12px; align-items:center; justify-content:flex-end; margin:10px 0 18px;}
    .plan-list {display:flex; flex-direction:column; gap:14px;}
    .plan-row {background:#0f2533; border-radius:12px; padding:12px 12px; display:grid; grid-template-columns: 28px 1fr 160px 1.2fr 44px; gap:12px; align-items:center; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .plan-row.done {opacity:.5;}
    .pill {background:#0d8e8a; border-radius:10px; padding:10px 14px; color:#fff; font-weight:700; text-align:center;}
    .qty-in {width:110px; text-align:center; padding:8px 10px; border-radius:10px; border:none; font-weight:700; letter-spacing:.5px}
    .changes {border:2px dashed rgba(255,255,255,.18); border-radius:10px; padding:10px 14px; min-height:44px; color:#bde7e5}
    .changes ul{ margin:0; padding-left:18px; }
    .changes li{ margin:2px 0; }
    .changes .muted{ opacity:.7; font-size:.95em; }
    .trash {width:42px; height:42px; border-radius:10px; background:#2a0e0e; color:#ff6666; border:2px solid #401717; font-weight:900; display:flex; align-items:center; justify-content:center}
    .drag {cursor:grab; font-size:18px; opacity:.8; padding-left:8px}
    .drag:active {cursor:grabbing;}
    .table-card {background:#0f2533; border-radius:14px; padding:16px; margin:24px 0 44px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .tbl h3 {margin:0 0 12px}
    .tbl table {width:100%}
    .tbl thead th {white-space:nowrap}
    .right {text-align:right}
    .center {text-align:center}
    .mini {opacity:.85; font-size:.95rem}
    .muted {opacity:.75}
    .btn-danger {background:#b94136}

    @media (max-width: 820px){
      .plan-row {grid-template-columns: 28px 1fr; gap:10px}
      .plan-row .qty-slot,
      .plan-row .chg-slot,
      .plan-row .trash-slot {grid-column: 1 / -1}
      .plan-row .qty-slot {display:flex; gap:12px; align-items:center;}
    }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html" title="Ir al inicio">
    <img src="img/logo.png" alt="Logo">
  </a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="btnBack" type="button">VOLVER</button>
</header>

<main class="wrap">
  <h2 id="pageTitle" style="text-align:center; margin:10px 0 8px;">PLAN DE HOY</h2>
  <p id="dateSub" class="mini" style="text-align:center; margin:0 0 8px;"></p>

  <div class="plan-toolbar">
    <button class="btn" id="btnMaterials"><span style="margin-right:6px">üìä</span>MATERIALES</button>
  </div>

  <section id="planList" class="plan-list" aria-live="polite"></section>

  <!-- MATERIALES AGREGADOS -->
  <section id="materialsBox" class="table-card" style="display:none;">
    <div class="tbl">
      <h3>MATERIALES PARA EL PLAN DE HOY</h3>
      <p class="mini muted">Las cantidades ya consideran el <b>factor</b> multiplicado por la <b>cantidad</b> de cada modelo (y se <b>redondean hacia arriba</b> por material).</p>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin:8px 0 10px">
        <button class="btn btn-compact" id="btnCheckAllGeneral">MARCAR TODO</button>
      </div>
      <div class="tabla">
        <table>
          <thead>
            <tr>
              <th>MATERIAL</th>
              <th>N√öMERO DE PARTE</th>
              <th class="right">CANTIDAD</th>
              <th class="center">‚úî</th>
            </tr>
          </thead>
          <tbody id="generalMat"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:flex-end; margin:12px 0 0;">
        <button class="btn" id="btnOKGeneral">OK</button>
      </div>
    </div>

    <div class="tbl" style="margin-top:28px;">
      <h3>KANBAN PARA EL PLAN DE HOY <span class="mini muted">(‚Äúbase‚Äù y ‚Äútapa‚Äù)</span></h3>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin:8px 0 10px">
        <button class="btn btn-compact" id="btnCheckAllKanban">MARCAR TODO</button>
      </div>
      <div class="tabla">
        <table>
          <thead>
          <tr>
            <th>MATERIAL</th>
            <th>N√öMERO DE PARTE</th>
            <th class="right">CANTIDAD</th>
            <th class="center">‚úî</th>
          </tr>
          </thead>
          <tbody id="kanbanMat"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:flex-end; margin:12px 0 0;">
        <button class="btn" id="btnOKKanban">OK</button>
      </div>
    </div>
  </section>
</main>

<script type="module" src="firebase-config.js"></script>
<script type="module">
  import { db } from "./firebase-config.js";
  import {
    doc, onSnapshot, setDoc, collection, onSnapshot as colSnapshot,
    orderBy, query, increment, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // -------- util --------
  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const fmt = n => (n||0).toLocaleString('es-MX');
  const todayKey = () => { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const prettyDate = () => new Date().toLocaleDateString('es-MX', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
  const getParams = () => { const p = new URLSearchParams(location.search); return { kb: (p.get('kb')||'HA').trim(), line: (p.get('line')||'L17').trim() }; };
  const sanitize = (s='') => String(s).replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));

  const SID_KEY = "materialistas.sessionId";
  let sessionId = localStorage.getItem(SID_KEY);
  if (!sessionId){ sessionId = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sessionId); }

  // -------- estado --------
  const params    = getParams();
  const dateKey   = todayKey();
  const base      = ['KB', params.kb, 'lines', params.line];
  const planDoc   = doc(db, ...base, 'plans', dateKey);

  const pageTitle = qs('#pageTitle');
  const dateSub   = qs('#dateSub');
  const planListEl= qs('#planList');
  const materialsBox = qs('#materialsBox');
  const generalEl = qs('#generalMat');
  const kanbanEl  = qs('#kanbanMat');

  qs('#btnBack').onclick = () => history.length>1 ? history.back() : (location.href='index.html');
  pageTitle.textContent = `PLAN DE HOY`;
  dateSub.textContent   = `(${prettyDate()})`;

  // cache de modelos -> materiales
  const modelCache = new Map();

  function killWatch(id){
    const ref = modelCache.get(id);
    if (ref?.unsubs) ref.unsubs.forEach(u=>{ try{u()}catch{} });
    modelCache.delete(id);
  }
  function watchModel(id){
    if (modelCache.has(id)) return;
    const unsubs = [];
    const kbDocRef = [...base, 'models', id];

    const setMaterialsFromData = (data, pathArr)=>{
      const embed = Array.isArray(data?.materials) ? data.materials : null;
      if (embed && embed.length){
        modelCache.set(id, { materials: embed.map(m=>({name:m.name||'', number:m.number||'', factor:Number(m.factor||0)})), unsubs });
        if (!suspendRender) { repaintChanges(); renderIfVisible(); }
        return;
      }
      const dref = doc(db, ...pathArr);
      const cref = collection(dref, 'materials');
      const u = colSnapshot(query(cref, orderBy('name','asc')), snap=>{
        const mats = snap.docs.map(d=>{ const m=d.data()||{}; return {name:m.name||'', number:m.number||'', factor:Number(m.factor||0)}; });
        modelCache.set(id, { materials: mats, unsubs });
        if (!suspendRender) { repaintChanges(); renderIfVisible(); }
      });
      unsubs.push(u);
    };

    // Esquema nuevo + legado (compat)
    import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js").then(({onSnapshot:docSnap})=>{
      unsubs.push(docSnap(doc(db, ...kbDocRef), snap=>{
        if (snap.exists()) setMaterialsFromData(snap.data()||{}, kbDocRef);
      }));
      const legacy = ['lines', params.line, 'models', id];
      unsubs.push(docSnap(doc(db, ...legacy), snap=>{
        if (snap.exists()) setMaterialsFromData(snap.data()||{}, legacy);
      }));
    });

    modelCache.set(id, { materials: [], unsubs });
  }

  let plan = []; // [{id,name,qty,done}]
  // Evitamos re-render de la lista mientras se escribe, pero s√≠ recalculamos materiales en vivo
  let suspendRender = false;

  onSnapshot(
    planDoc,
    { includeMetadataChanges: true },
    snap=>{
      const data  = snap.data() || {};
      const items = Array.isArray(data.items) ? data.items : [];

      const idsNow = new Set(items.map(x=>x.id));
      for (const id of Array.from(modelCache.keys())) if (!idsNow.has(id)) killWatch(id);
      items.forEach(it => watchModel(it.id));

      plan = items.map(x => ({ id:x.id, name:x.name||x.display||'SIN NOMBRE', qty:Number(x.qty||0), done:!!x.done }));

      if (!suspendRender && !snap.metadata.hasPendingWrites){
        renderPlan();
        renderIfVisible();
      }
    }
  );

  function changesHTML(idx){
    if (idx===0) return 'Modelo de arranque';
    const prevM = modelCache.get(plan[idx-1]?.id)?.materials || [];
    const curM  = modelCache.get(plan[idx]?.id)?.materials  || [];
    const prevSet = new Set(prevM.map(m => (m.number||'').trim()));
    const changed = curM.filter(m => m.number && !prevSet.has(m.number.trim()));
    if (!changed.length) return 'No cambia nada';
    const items = changed.map(m => `<li>${sanitize(m.name)} <span class="muted">(${sanitize(m.number)})</span></li>`).join('');
    return `<ul>${items}</ul>`;
  }

  function renderPlan(){
    if (!plan.length){
      planListEl.innerHTML = `<div class="table-card" style="text-align:center; opacity:.75">No hay modelos en el plan de hoy.</div>`;
      return;
    }
    planListEl.innerHTML = plan.map((it,idx) => `
      <div class="plan-row ${it.done ? 'done':''}" data-idx="${idx}" draggable="true">
        <div class="center"><input type="checkbox" class="chk-done" ${it.done?'checked':''} title="Hecho"></div>
        <div class="pill drag" title="Arrastrar para reordenar">‚ãÆ‚ãÆ ${sanitize(it.name)}</div>
        <div class="qty-slot"><input class="qty-in" type="number" min="0" step="1" value="${it.qty}" aria-label="Cantidad"></div>
        <div class="chg-slot"><div class="changes" data-chg="${idx}">${changesHTML(idx)}</div></div>
        <div class="trash-slot"><button class="trash" title="Eliminar">üóë</button></div>
      </div>
    `).join('');
    addRowEventHandlers();
  }

  // S√≥lo repintar la columna de cambios
  function repaintChanges(){
    qsa('.changes').forEach(chg => {
      const idx = Number(chg.dataset.chg);
      chg.innerHTML = changesHTML(idx);
    });
  }

  // Obtener plan EN VIVO desde el DOM (para c√°lculos en tiempo real)
  function planLiveFromDOM(){
    const rows = qsa('.plan-row');
    return rows.map(r=>{
      const idx = Number(r.dataset.idx||0);
      const qty = Number(r.querySelector('.qty-in')?.value || 0);
      return { ...plan[idx], qty };
    });
  }

  function addRowEventHandlers(){
    qsa('.plan-row').forEach(row=>{
      const idx = Number(row.dataset.idx);

      // Hecho / no hecho (persistente)
      row.querySelector('.chk-done')?.addEventListener('change', async (e)=>{
        const done = !!e.target.checked;
        await setDoc(planDoc, { items: plan.map((x,i)=> i===idx ? {...x, done} : x) }, { merge:true });
      });

      // Cantidad:
      const qtyIn = row.querySelector('.qty-in');

      // a) En vivo: recalcular materiales al teclear (sin escribir a Firestore)
      qtyIn?.addEventListener('input', ()=>{
        if (materialsVisible) renderMaterials(planLiveFromDOM());
      });

      // b) Evitar re-render de la lista mientras se escribe
      qtyIn?.addEventListener('focus', ()=> suspendRender = true);

      // c) Al terminar (blur) s√≠ persistimos la cantidad
      qtyIn?.addEventListener('blur',  async ()=>{
        suspendRender = false;
        const qty = Number(qtyIn.value||0);
        await setDoc(planDoc, { items: plan.map((x,i)=> i===idx ? {...x, qty} : x) }, { merge:true });
      });

      // Eliminar fila
      row.querySelector('.trash')?.addEventListener('click', async ()=>{
        const next = plan.filter((_,i)=> i!==idx);
        await setDoc(planDoc, { items: next }, { merge:true });
        if (materialsVisible) renderMaterials(planLiveFromDOM());
      });

      // Drag & drop para reordenar
      row.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', String(idx));
      });
      row.addEventListener('dragover', e=> e.preventDefault());
      row.addEventListener('drop', async e=>{
        e.preventDefault();
        const from = Number(e.dataTransfer.getData('text/plain'));
        const to   = idx;
        if (Number.isNaN(from) || from===to) return;
        const arr = plan.slice();
        const [moved] = arr.splice(from,1);
        arr.splice(to,0,moved);
        await setDoc(planDoc, { items: arr }, { merge:true });
        if (materialsVisible) renderMaterials(planLiveFromDOM());
      });
    });
  }

  // ------ Materiales agregados (sumatoria por l√≠nea con REDONDEO ARRIBA) ------
  function materialKey(m){ return (m.number||'').trim(); }

  // acepta un arreglo de items (plan) para permitir c√°lculos ‚Äúlive‚Äù
  function sumMaterials(planItems){
    const sumGeneral = new Map(); // number -> {name, number, totalRaw}
    const sumKanban  = new Map();

    for (const it of planItems){
      const qty = Number(it.qty||0);
      if (!qty) continue;
      const mats = modelCache.get(it.id)?.materials || [];
      for (const m of mats){
        const key = materialKey(m);
        if (!key) continue;
        const isKanban = /\b(base|tapa|kanban)\b/i.test(m.name||"");
        const raw = qty * Number(m.factor||0); // puede ser decimal
        const dst = isKanban ? sumKanban : sumGeneral;
        const cur = dst.get(key) || { name:m.name||'', number:m.number||'', totalRaw:0 };
        cur.totalRaw += raw; // acumulamos crudo
        dst.set(key, cur);
      }
    }

    // Al final, redondeamos hacia arriba por material
    const mapToArray = (map)=> Array.from(map.values()).map(x=>({
      name: x.name, number: x.number, qty: Math.ceil(x.totalRaw)
    })).sort((a,b)=> String(a.number).localeCompare(String(b.number)));

    return { general: mapToArray(sumGeneral), kanban: mapToArray(sumKanban) };
  }

  // opcional planOverride para c√°lculos en vivo
  function renderMaterials(planOverride){
    const basePlan = planOverride || plan;
    const {general, kanban} = sumMaterials(basePlan);
    const rowHTML = (r)=>`
      <tr>
        <td>${sanitize(r.name)}</td>
        <td>${sanitize(r.number)}</td>
        <td class="right">${fmt(r.qty)}</td>
        <td class="center"><input type="checkbox" class="chk"></td>
      </tr>`;
    generalEl.innerHTML = general.map(rowHTML).join('');
    kanbanEl.innerHTML  = kanban.map(rowHTML).join('');
  }

  let materialsVisible = false;
  function renderIfVisible(){ if (materialsVisible) renderMaterials(planLiveFromDOM()); }

  // Mostrar/ocultar panel de materiales
  qs('#btnMaterials').onclick = ()=>{
    materialsVisible = !materialsVisible;
    materialsBox.style.display = materialsVisible ? 'block' : 'none';
    if (materialsVisible) renderMaterials(planLiveFromDOM());
  };

  // Marcar todo
  function toggleAll(box, on){
    Array.from(box.querySelectorAll('.chk')).forEach(c=> c.checked = on);
  }
  qs('#btnCheckAllGeneral').onclick = ()=> toggleAll(generalEl, true);
  qs('#btnCheckAllKanban').onclick  = ()=> toggleAll(kanbanEl,  true);

  // Env√≠o a 311 por L√çNEA ‚Äî usa las cantidades ya redondeadas
  async function sendChecked(box, subcollection){
    const rows = Array.from(box.querySelectorAll('tr')).filter(tr => tr.querySelector('.chk')?.checked);
    if (!rows.length){ alert('No has marcado materiales.'); return; }
    const updates = rows.map(tr=>{
      const tds = tr.querySelectorAll('td');
      const name = tds[0]?.textContent?.trim() || '';
      const number = tds[1]?.textContent?.trim() || '';
      const qty = Number((tds[2]?.textContent||'').replace(/[^\d.-]/g,''))||0; // ya viene redondeado
      return { name, number, qty };
    }).filter(x=> x.number && x.qty>0);

    for (const r of updates){
      const docRef = doc(db, ...base, 'users', sessionId, subcollection, r.number);
      await setDoc(docRef, { number:r.number, name:r.name, qty: increment(r.qty), updatedAt: serverTimestamp() }, { merge:true });
    }
    alert('Enviado a 311.');
  }

  qs('#btnOKGeneral').onclick = ()=> sendChecked(generalEl, 'cart');
  qs('#btnOKKanban').onclick  = ()=> sendChecked(kanbanEl,  'kanbanCart');
</script>
</body>
</html>
