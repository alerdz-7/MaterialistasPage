<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plan de hoy</title>

  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style-modelos.css"/>

  <style>
    .wrap {max-width: 1200px; margin: 0 auto; padding: 0 12px;}
    .plan-toolbar {display:flex; gap:12px; align-items:center; justify-content:flex-end; margin:10px 0 18px;}
    .plan-list {display:flex; flex-direction:column; gap:14px;}
    .plan-row {background:#0f2533; border-radius:12px; padding:12px 12px; display:grid; grid-template-columns: 28px 1fr 160px 1.2fr 44px; gap:12px; align-items:center; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .plan-row.done {opacity:.5;}
    .pill {background:#0d8e8a; border-radius:10px; padding:10px 14px; color:#fff; font-weight:700; text-align:center;}
    .qty-in {width:110px; text-align:center; padding:8px 10px; border-radius:10px; border:none; font-weight:700; letter-spacing:.5px}
    .changes {border:2px dashed rgba(255,255,255,.18); border-radius:10px; padding:10px 14px; min-height:44px; color:#bde7e5}
    .changes ul{ margin:0; padding-left:18px; }
    .changes li{ margin:2px 0; }
    .changes .muted{ opacity:.7; font-size:.95em; }
    .trash {width:42px; height:42px; border-radius:10px; background:#2a0e0e; color:#ff6666; border:2px solid #401717; font-weight:900; display:flex; align-items:center; justify-content:center}
    .drag {cursor:grab; font-size:18px; opacity:.8; padding-left:8px}
    .drag:active {cursor:grabbing;}
    .table-card {background:#0f2533; border-radius:14px; padding:16px; margin:24px 0 44px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .tbl h3 {margin:0 0 12px}
    .tbl table {width:100%}
    .tbl thead th {white-space:nowrap}
    .right {text-align:right}
    .center {text-align:center}
    .mini {opacity:.85; font-size:.95rem}
    .muted {opacity:.75}
    .btn-danger {background:#b94136}

    @media (max-width: 820px){
      .plan-row {grid-template-columns: 28px 1fr; gap:10px}
      .plan-row .qty-slot,
      .plan-row .chg-slot,
      .plan-row .trash-slot {grid-column: 1 / -1}
      .plan-row .qty-slot {display:flex; gap:12px; align-items:center;}
    }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html" title="Ir al inicio">
    <img src="img/logo.png" alt="Logo">
  </a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="btnBack" type="button">VOLVER</button>
</header>

<main class="wrap">
  <h2 id="pageTitle" style="text-align:center; margin:10px 0 8px;">PLAN DE HOY</h2>
  <p id="dateSub" class="mini" style="text-align:center; margin:0 0 8px;"></p>

  <div class="plan-toolbar">
    <button class="btn" id="btnMaterials"><span style="margin-right:6px">üìä</span>MATERIALES</button>
  </div>

  <section id="planList" class="plan-list" aria-live="polite"></section>

  <!-- MATERIALES AGREGADOS -->
  <section id="materialsBox" class="table-card" style="display:none;">
    <div class="tbl">
      <h3>MATERIALES PARA EL PLAN DE HOY</h3>
      <p class="mini muted">Las cantidades ya consideran el <b>factor</b> multiplicado por la <b>cantidad</b> de cada modelo.</p>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin:8px 0 10px">
        <button class="btn btn-compact" id="btnCheckAllGeneral">MARCAR TODO</button>
      </div>
      <div class="tabla">
        <table>
          <thead>
            <tr>
              <th>MATERIAL</th>
              <th>N√öMERO DE PARTE</th>
              <th class="right">CANTIDAD</th>
              <th class="center">‚úî</th>
            </tr>
          </thead>
          <tbody id="generalMat"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:flex-end; margin:12px 0 0;">
        <button class="btn" id="btnOKGeneral">OK</button>
      </div>
    </div>

    <div class="tbl" style="margin-top:28px;">
      <h3>KANBAN PARA EL PLAN DE HOY <span class="mini muted">(‚Äúbase‚Äù y ‚Äútapa‚Äù)</span></h3>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin:8px 0 10px">
        <button class="btn btn-compact" id="btnCheckAllKanban">MARCAR TODO</button>
      </div>
      <div class="tabla">
        <table>
          <thead>
          <tr>
            <th>MATERIAL</th>
            <th>N√öMERO DE PARTE</th>
            <th class="right">CANTIDAD</th>
            <th class="center">‚úî</th>
          </tr>
          </thead>
          <tbody id="kanbanMat"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:flex-end; margin:12px 0 0;">
        <button class="btn" id="btnOKKanban">OK</button>
      </div>
    </div>
  </section>
</main>

<script type="module" src="firebase-config.js"></script>
<script type="module">
  import { db } from "./firebase-config.js";
  import {
    doc, onSnapshot, setDoc, collection, onSnapshot as colSnapshot,
    orderBy, query, increment, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // -------- util --------
  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const fmt = n => (n||0).toLocaleString('es-MX');
  const todayKey = () => { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const prettyDate = () => new Date().toLocaleDateString('es-MX', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
  const getParams = () => { const p = new URLSearchParams(location.search); return { kb: p.get('kb')||'HA', line: p.get('line')||'L17' }; };
  const sanitize = (s='') => String(s).replace(/[<>&]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));

  const SID_KEY = "materialistas.sessionId";
  let sessionId = localStorage.getItem(SID_KEY);
  if (!sessionId){ sessionId = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sessionId); }

  // -------- estado --------
  const params    = getParams();
  const dateKey   = todayKey();
  const planDoc   = doc(db, 'KB', params.kb, 'lines', params.line, 'plans', dateKey);

  const pageTitle = qs('#pageTitle');
  const dateSub   = qs('#dateSub');
  const planListEl= qs('#planList');
  const materialsBox = qs('#materialsBox');
  const generalEl = qs('#generalMat');
  const kanbanEl  = qs('#kanbanMat');

  pageTitle.textContent = `PLAN DE HOY`;
  dateSub.textContent   = `(${prettyDate()})`;

  // cache de modelos -> materiales
  const modelCache = new Map();

  function killWatch(id){
    const ref = modelCache.get(id);
    if (ref?.unsubs) ref.unsubs.forEach(u=>{ try{u()}catch{} });
    modelCache.delete(id);
  }
  function watchModel(id){
    if (modelCache.has(id)) return;
    const unsubs = [];
    const kbDocRef = ['KB', params.kb, 'lines', params.line, 'models', id];

    const setMaterialsFromData = (data, pathArr)=>{
      const embed = Array.isArray(data?.materials) ? data.materials : null;
      if (embed && embed.length){
        modelCache.set(id, { materials: embed.map(m=>({name:m.name||'', number:m.number||'', factor:Number(m.factor||0)})), unsubs });
        if (!suspendRender) { repaintChanges(); renderIfVisible(); }
        return;
      }
      const dref = doc(db, ...pathArr);
      const cref = collection(dref, 'materials');
      const u = colSnapshot(query(cref, orderBy('name','asc')), snap=>{
        const mats = snap.docs.map(d=>{ const m=d.data()||{}; return {name:m.name||'', number:m.number||'', factor:Number(m.factor||0)}; });
        modelCache.set(id, { materials: mats, unsubs });
        if (!suspendRender) { repaintChanges(); renderIfVisible(); }
      });
      unsubs.push(u);
    };

    unsubs.push(onSnapshot(doc(db, ...kbDocRef), snap=>{
      if (snap.exists()) setMaterialsFromData(snap.data()||{}, kbDocRef);
    }));
    const legacy = ['lines', params.line, 'models', id];
    unsubs.push(onSnapshot(doc(db, ...legacy), snap=>{
      if (snap.exists()) setMaterialsFromData(snap.data()||{}, legacy);
    }));

    modelCache.set(id, { materials: [], unsubs });
  }

  let plan = []; // [{id,name,qty,done}]
  // üî∏ Cuando un input est√° activo, NO redibujamos la lista
  let suspendRender = false;

  onSnapshot(
    planDoc,
    { includeMetadataChanges: true },
    snap=>{
      const data  = snap.data() || {};
      const items = Array.isArray(data.items) ? data.items : [];

      const idsNow = new Set(items.map(x=>x.id));
      for (const id of Array.from(modelCache.keys())) if (!idsNow.has(id)) killWatch(id);
      items.forEach(it => watchModel(it.id));

      plan = items.map(x => ({ id:x.id, name:x.name||x.display||'SIN NOMBRE', qty:Number(x.qty||0), done:!!x.done }));

      // Si estamos escribiendo en alguna cantidad, no toques el DOM.
      if (!suspendRender && !snap.metadata.hasPendingWrites){
        renderPlan();
        renderIfVisible();
      }
    }
  );

  function changesHTML(idx){
    if (idx===0) return 'Modelo de arranque';
    const prevM = modelCache.get(plan[idx-1]?.id)?.materials || [];
    const curM  = modelCache.get(plan[idx]?.id)?.materials  || [];
    const prevSet = new Set(prevM.map(m => (m.number||'').trim()));
    const changed = curM.filter(m => m.number && !prevSet.has(m.number.trim()));
    if (!changed.length) return 'No cambia nada';
    const items = changed.map(m => `<li>${sanitize(m.name)} <span class="muted">(${sanitize(m.number)})</span></li>`).join('');
    return `<ul>${items}</ul>`;
  }

  function renderPlan(){
    if (!plan.length){
      planListEl.innerHTML = `<div class="table-card" style="text-align:center; opacity:.75">No hay modelos en el plan de hoy.</div>`;
      return;
    }
    planListEl.innerHTML = plan.map((it,idx) => `
      <div class="plan-row ${it.done ? 'done':''}" data-idx="${idx}" draggable="true">
        <div class="center"><input type="checkbox" class="chk-done" ${it.done?'checked':''} title="Hecho"></div>
        <div class="pill drag" title="Arrastrar para reordenar">‚ãÆ‚ãÆ ${sanitize(it.name)}</div>
        <div class="qty-slot"><input class="qty-in" type="number" min="0" step="1" value="${it.qty}" aria-label="Cantidad"></div>
        <div class="chg-slot"><div class="changes" data-chg="${idx}">${changesHTML(idx)}</div></div>
        <div class="trash-slot"><button class="trash" title="Eliminar">üóë</button></div>
      </div>
    `).join('');
    addRowEventHandlers();
  }

  // S√≥lo repintar la columna de cambios
  function repaintChanges(){
    qsa('.changes').forEach(chg => {
      const idx = Number(chg.dataset.chg);
      chg.innerHTML = changesHTML(idx);
    });
  }

  function addRowEventHandlers(){
    qsa('.plan-row').forEach(row=>{
      const idx = Number(row.dataset.idx);

      // Hecho / no hecho
      row.querySelector('.chk-done')?.addEventListener('change', e=>{
        plan[idx].done = e.target.checked;
        row.classList.toggle('done', plan[idx].done);
        pushPlan(true);
      });

      const qty = row.querySelector('.qty-in');
      if (qty){
        // mientras editas, suspendemos render
        qty.addEventListener('focus', ()=>{ suspendRender = true; });
        qty.addEventListener('blur',  ()=>{
          suspendRender = false;
          plan[idx].qty = Math.max(0, Number(qty.value||0));
          renderIfVisible();   // actualizar totales si la caja est√° abierta
          pushPlan(false, true); // guarda inmediato al salir
        });
        qty.addEventListener('input', e=>{
          plan[idx].qty = Math.max(0, Number(e.target.value||0));
          if (materialsBox.style.display==='block') renderAggregated();
          pushPlan(); // debounce
        });
        // Enter = quitar foco (√∫til en m√≥vil)
        qty.addEventListener('keydown', ev=>{
          if (ev.key === 'Enter') qty.blur();
        });
      }

      // Eliminar
      row.querySelector('.trash')?.addEventListener('click', ()=>{
        const copy = plan.slice(); copy.splice(idx,1); plan = copy; pushPlan(true);
      });

      // Drag & drop
      row.addEventListener('dragstart', ev=>{
        ev.dataTransfer.setData('text/plain', idx.toString());
        row.style.opacity = .5;
      });
      row.addEventListener('dragend', ()=> row.style.opacity = '');
      row.addEventListener('dragover', ev=> ev.preventDefault());
      row.addEventListener('drop', ev=>{
        ev.preventDefault();
        const from = Number(ev.dataTransfer.getData('text/plain'));
        const to   = Number(row.dataset.idx);
        if (isNaN(from) || isNaN(to) || from===to) return;
        const copy = plan.slice();
        const [moved] = copy.splice(from,1);
        copy.splice(to,0,moved);
        plan = copy;
        pushPlan(true);
      });
    });
  }

  // Empuja cambios del array completo
  let pushTimer=null;
  function pushPlan(coalesceOrder=false, flushNow=false){
    clearTimeout(pushTimer);
    const write = async ()=>{
      const items = plan.map(p => ({ id:p.id, name:p.name, qty:Number(p.qty||0), done:!!p.done }));
      await setDoc(planDoc, { items }, { merge:true });
    };
    if (flushNow){ write(); return; }
    // debounce m√°s largo para que no ‚Äúrebote‚Äù el DOM al teclear
    pushTimer = setTimeout(write, 500);
  }

  // ------- materiales totales -------
  function normalizeName(s=''){ return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
  function isKanbanName(name=''){ const n=normalizeName(name); return /\bbase\b/.test(n) || /\btapa\b/.test(n); }

  function aggregateMaterials(){
    const agg={}, aggK={};
    for (const it of plan){
      const q = Number(it.qty||0); if (!q) continue;
      const mats = modelCache.get(it.id)?.materials || [];
      for (const m of mats){
        const part=(m.number||'').trim(); const f=Number(m.factor||0); const add=q*f;
        if (!part || add<=0) continue;
        const target = isKanbanName(m.name) ? aggK : agg;
        if (!target[part]) target[part]={name:m.name||'', number:part, total:0};
        target[part].total += add;
      }
    }
    return {
      general: Object.values(agg).sort((a,b)=> a.name.localeCompare(b.name)),
      kanban : Object.values(aggK).sort((a,b)=> a.name.localeCompare(b.name)),
    };
  }

  function renderAggregated(){
    const {general, kanban} = aggregateMaterials();
    const G = general.length ? general.map(r=>`
      <tr><td>${sanitize(r.name)}</td><td>${sanitize(r.number)}</td><td class="right">${fmt(r.total)}</td><td class="center"><input type="checkbox" class="chk-g"></td></tr>
    `).join('') : `<tr><td colspan="4" class="center muted">Sin materiales (asigna cantidades a los modelos)</td></tr>`;
    const K = kanban.length ? kanban.map(r=>`
      <tr><td>${sanitize(r.name)}</td><td>${sanitize(r.number)}</td><td class="right">${fmt(r.total)}</td><td class="center"><input type="checkbox" class="chk-k"></td></tr>
    `).join('') : `<tr><td colspan="4" class="center muted">Sin materiales Kanban</td></tr>`;
    generalEl.innerHTML = G; kanbanEl.innerHTML = K;
  }
  function renderIfVisible(){ if (materialsBox.style.display==='block') renderAggregated(); }

  // -------- UI general --------
  qs('#btnBack').onclick = () => history.length>1 ? history.back() : (location.href='index.html');
  qs('#btnMaterials').onclick = ()=>{ const open = !(materialsBox.style.display==='block'); materialsBox.style.display = open?'block':'none'; if (open) renderAggregated(); };
  qs('#btnCheckAllGeneral').onclick = ()=> qsa('.chk-g').forEach(c=> c.checked = true);
  qs('#btnCheckAllKanban').onclick  = ()=> qsa('.chk-k').forEach(c=> c.checked = true);

  // Env√≠o a 311 por dispositivo (misma sesi√≥n que 311.html)
  async function ensureUserDoc(){
    const ref = doc(db, "KB", params.kb, "lines", params.line, "users", sessionId);
    await setDoc(ref, { active:true, updatedAt: serverTimestamp() }, { merge:true });
  }
  async function addRowsTo(kind, selector){
    await ensureUserDoc();
    const updates=[];
    qsa(selector).forEach(tr=>{
      const chk = tr.querySelector('input[type="checkbox"]'); if (!chk?.checked) return;
      const num = tr.children[1]?.textContent.trim();
      const qty = Number((tr.children[2]?.textContent||'0').replace(/[^\d]/g,'')) || 0;
      if (!num || qty<=0) return;
      const ref = doc(db, "KB", params.kb, "lines", params.line, "users", sessionId, kind, num);
      updates.push(setDoc(ref, { number:num, qty: increment(qty) }, { merge:true }));
    });
    if (updates.length) await Promise.all(updates);
  }
  qs('#btnOKGeneral').onclick = async ()=>{ await addRowsTo("cart", "#generalMat tr");   alert('Material agregado a 311 (general).'); };
  qs('#btnOKKanban').onclick  = async ()=>{ await addRowsTo("kanbanCart", "#kanbanMat tr"); alert('Material agregado a 311 (Kanban).'); };
</script>
</body>
</html>
