<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>311</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style-modelos.css"/>
  <style>
    .wrap{ max-width:1200px; margin:0 auto; padding:0 12px; }
    .section{ margin:26px auto 36px; max-width:720px; }
    .section-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:8px 0 10px; }
    .section-head h3{ margin:0; }
    .actions{ display:flex; gap:10px; align-items:center; }
    .tabla { margin:0 auto; }
    .right{ text-align:right; }
    .muted{ opacity:.75; }
    .tiny{ font-size:.9rem; opacity:.8; }
    .empty{ text-align:center; opacity:.7; padding:10px 0; }
    .btn-ghost{ background:#213444; }
    /* modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal .card{ width:min(920px, 92vw); max-height:82vh; overflow:auto; background:#0f2533; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35) }
    .modal .head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .modal .close{ background:#213444; color:#fff; border:none; border-radius:10px; padding:8px 10px; cursor:pointer }
    .hist-item{ background:#132b3a; border-radius:12px; padding:12px; margin:10px 0 }
    .hist-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html" title="Ir al inicio">
    <img src="img/logo.png" alt="Logo">
  </a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="backBtn" type="button">VOLVER</button>
</header>

<main class="wrap">
  <h2 id="titleH2" class="detalle-titulo" style="text-align:center; margin:12px 0 2px;">MATERIAL POR PEDIR EN 311</h2>

  <!-- ===== MATERIAL GENERAL ===== -->
  <section class="section" id="secMain">
    <div class="section-head">
      <h3>Material</h3>
      <div class="actions">
        <button class="btn" id="copyMain">Copiar</button>
        <button class="btn btn-danger" id="clearMain" title="Borra SOLO tu lista en esta línea">Borrar</button>
        <button class="btn btn-compact btn-ghost" id="histMain">🕘 Historial</button>
      </div>
    </div>

    <div class="tabla">
      <table>
        <thead>
          <tr><th>NÚMERO DE PARTE</th><th class="right">CANTIDAD</th></tr>
        </thead>
        <tbody id="tblMain"></tbody>
      </table>
    </div>
    <div id="emptyMain" class="empty">(Vacío)</div>
    <div class="tiny muted" style="text-align:right" id="copiedMain"></div>
  </section>

  <!-- ===== KANBAN ===== -->
  <section class="section" id="secKanban">
    <div class="section-head">
      <h3>Kanban</h3>
      <div class="actions">
        <button class="btn" id="copyKanban">Copiar</button>
        <button class="btn btn-danger" id="clearKanban" title="Borra SOLO tu lista en esta línea">Borrar</button>
        <button class="btn btn-compact btn-ghost" id="histKanban">🕘 Historial</button>
      </div>
    </div>

    <div class="tabla">
      <table>
        <thead>
          <tr><th>NÚMERO DE PARTE</th><th class="right">CANTIDAD</th></tr>
        </thead>
        <tbody id="tblKanban"></tbody>
      </table>
    </div>
    <div id="emptyKanban" class="empty">(Vacío)</div>
    <div class="tiny muted" style="text-align:right" id="copiedKanban"></div>
  </section>
</main>

<!-- HISTORIAL MODAL -->
<div class="modal" id="histModal" aria-hidden="true">
  <div class="card">
    <div class="head">
      <h3 style="margin:0" id="histTitle">Historial</h3>
      <button class="close" id="histClose">Cerrar</button>
    </div>
    <div id="histList"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module" src="firebase-config.js"></script>
<script type="module">
  import { db } from "./firebase-config.js"; /* export db en tu proyecto :contentReference[oaicite:3]{index=3} */
  import {
    collection, onSnapshot, deleteDoc, doc, addDoc, getDocs, getDoc,
    orderBy, query, setDoc, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ===== util =====
  const fmt = n => (Number(n||0)).toLocaleString("es-MX");
  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const p   = new URLSearchParams(location.search);
  const kb   = (p.get("kb")||"HA").trim();
  const line = (p.get("line")||"L17").trim();

  // Navegación + título contextual (muestra KB/Línea)
  qs("#backBtn").onclick = () => history.length > 1 ? history.back() : (location.href = "index.html");
  qs("#titleH2").textContent = `MATERIAL POR PEDIR EN 311 — ${kb} / ${line}`;

  // ===== BasePath por KB/LÍNEA (todo queda aislado aquí) =====
  const base = ["KB", kb, "lines", line];

  // ===== Render básico =====
  const tbodyMain   = qs("#tblMain");
  const tbodyKanban = qs("#tblKanban");

  function paint(tbody, list){
    if (!list.length){ tbody.innerHTML=""; return; }
    list.sort((a,b)=> String(a.number).localeCompare(String(b.number)));
    tbody.innerHTML = list.map(r=> `
      <tr><td>${r.number}</td><td class="right">${fmt(r.qty)}</td></tr>
    `).join("");
  }
  function refreshEmptyHints(){
    qs("#emptyMain").style.display   = tbodyMain.children.length   ? "none" : "block";
    qs("#emptyKanban").style.display = tbodyKanban.children.length ? "none" : "block";
  }

  // ===== Agregado compartido por LÍNEA (users/*/(cart|kanbanCart)) =====
  const usersCol = collection(db, ...base, "users");
  const perUserMain   = new Map();
  const perUserKanban = new Map();
  const perUserUnsubs = new Map();

  function recomputeAndPaint(){
    const aggMain = new Map();
    for (const m of perUserMain.values())
      for (const [num, qty] of m.entries())
        aggMain.set(num, (aggMain.get(num)||0) + qty);

    const aggKanban = new Map();
    for (const m of perUserKanban.values())
      for (const [num, qty] of m.entries())
        aggKanban.set(num, (aggKanban.get(num)||0) + qty);

    paint(tbodyMain,   Array.from(aggMain,   ([number, qty])=>({number, qty})));
    paint(tbodyKanban, Array.from(aggKanban, ([number, qty])=>({number, qty})));
    refreshEmptyHints();
  }

  function listenUserSub(userId){
    if (perUserUnsubs.has(userId)) return;
    const unsubs = {};
    // carrito "general"
    unsubs.cart = onSnapshot(query(collection(db, ...base, "users", userId, "cart"), orderBy("number","asc")),
      snap=>{
        const m = new Map();
        snap.docs.forEach(d=>{
          const data=d.data()||{};
          const num = String(data.number || d.id).trim();
          const qty = Number(data.qty||0);
          if (num && qty>0) m.set(num, qty);
        });
        perUserMain.set(userId, m);
        recomputeAndPaint();
      });
    // carrito "kanban"
    unsubs.kanban = onSnapshot(query(collection(db, ...base, "users", userId, "kanbanCart"), orderBy("number","asc")),
      snap=>{
        const m = new Map();
        snap.docs.forEach(d=>{
          const data=d.data()||{};
          const num = String(data.number || d.id).trim();
          const qty = Number(data.qty||0);
          if (num && qty>0) m.set(num, qty);
        });
        perUserKanban.set(userId, m);
        recomputeAndPaint();
      });

    perUserUnsubs.set(userId, unsubs);
  }
  function unlistenUserSub(userId){
    const u = perUserUnsubs.get(userId);
    if (u){ try{u.cart&&u.cart()}catch{}; try{u.kanban&&u.kanban()}catch{}; }
    perUserUnsubs.delete(userId);
    perUserMain.delete(userId);
    perUserKanban.delete(userId);
    recomputeAndPaint();
  }
  onSnapshot(usersCol, snap=>{
    snap.docChanges().forEach(ch=>{
      const id = ch.doc.id;
      if (ch.type === "added" || ch.type === "modified") listenUserSub(id);
      if (ch.type === "removed") unlistenUserSub(id);
    });
    snap.docs.forEach(d=> listenUserSub(d.id));
  });

  // ===== Meta + Historial (aislados por LÍNEA) =====
  const metaRef = doc(db, ...base, "shared311_meta", "state");
  const histCol = collection(db, ...base, "shared311_history");

  onSnapshot(metaRef, snap=>{
    const data = snap.data()||{};
    const toText = ts => ts instanceof Timestamp
      ? `Copiado el ${ts.toDate().toLocaleDateString('es-MX')} a las ${ts.toDate().toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit', hour12:true })}`
      : '';
    qs("#copiedMain").textContent   = toText(data.mainCopiedAt || null);
    qs("#copiedKanban").textContent = toText(data.kanbanCopiedAt || null);
  });

  // ===== Helpers de copiar/pegar =====
  function tableToList(tbody){
    return Array.from(tbody.querySelectorAll("tr")).map(tr=>{
      const tds = tr.querySelectorAll("td");
      return { number: (tds[0]?.textContent||"").trim(), qty: Number((tds[1]?.textContent||"").replace(/[^\d.-]/g,""))||0 };
    }).filter(x=>x.number && x.qty>0);
  }
  async function copyList(list, scope){ // scope: "main" | "kanban"
    if (!list.length){ alert("No hay materiales para copiar."); return; }
    const text = list.map(r => `${r.number}\t${r.qty}`).join("\n");
    await navigator.clipboard.writeText(text);
    await setDoc(metaRef, scope==="main" ? { mainCopiedAt: serverTimestamp() } : { kanbanCopiedAt: serverTimestamp() }, { merge:true });
    await addDoc(histCol, { scope, items: list, createdAt: serverTimestamp() });
    return text;
  }

  // Copiar
  qs("#copyMain").onclick   = async ()=>{ const list = tableToList(tbodyMain);   await copyList(list, "main"); };
  qs("#copyKanban").onclick = async ()=>{ const list = tableToList(tbodyKanban); await copyList(list, "kanban"); };

  // ===== Borrar: SOLO mi carrito en ESTA línea =====
  const SID_KEY = "materialistas.sessionId";
  let sessionId = localStorage.getItem(SID_KEY);
  if (!sessionId){ sessionId = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sessionId); }

  async function clearFor(meRefPath){
    const sub = collection(db, ...meRefPath);
    const snap = await getDocs(sub);
    await Promise.all(snap.docs.map(d => deleteDoc(doc(db, ...meRefPath, d.id))));
  }
  qs("#clearMain").onclick = async ()=>{
    const me = [...base, "users", sessionId, "cart"];      // KB/kb/lines/line/users/{sessionId}/cart
    await clearFor(me);
  };
  qs("#clearKanban").onclick = async ()=>{
    const me = [...base, "users", sessionId, "kanbanCart"]; // KB/kb/lines/line/users/{sessionId}/kanbanCart
    await clearFor(me);
  };

  // ===== Historial (solo de ESTA línea) =====
  const histModal = qs("#histModal");
  const histTitle = qs("#histTitle");
  const histList  = qs("#histList");
  qs("#histClose").onclick = ()=>{ histModal.style.display='none'; histModal.setAttribute('aria-hidden','true'); };

  async function openHistory(scope){
    histTitle.textContent = scope==="main" ? "Historial — Material" : "Historial — Kanban";
    const qy = query(histCol, orderBy("createdAt","desc"));
    const snap = await getDocs(qy);
    const items = snap.docs
      .map(d=>({ id:d.id, ...d.data() }))
      .filter(x=> x.scope===scope)
      .slice(0, 10);

    if (!items.length){
      histList.innerHTML = `<div class="muted" style="text-align:center">Sin registros todavía</div>`;
    } else {
      histList.innerHTML = items.map(it=>{
        const when = it.createdAt?.toDate?.()?.toLocaleString?.("es-MX",{hour12:true}) || "";
        const body = (it.items||[]).map(r => `<div class="mono" style="opacity:.9">${r.number}\t${r.qty}</div>`).join("");
        return `
          <div class="hist-item">
            <div class="head" style="display:flex; align-items:center; justify-content:space-between; gap:8px">
              <div class="tiny muted">${when}</div>
              <div class="hist-actions">
                <button class="btn btn-compact" data-copy="${it.id}">Copiar</button>
              </div>
            </div>
            ${body}
          </div>
        `;
      }).join("");

      // volver a copiar un snapshot del historial
      qsa('[data-copy]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute('data-copy');
          const ref = doc(db, ...base, "shared311_history", id);
          const s = await getDoc(ref);
          const data = s.data()||{};
          const txt = (data.items||[]).map(r=>`${r.number}\t${r.qty}`).join("\n");
          await navigator.clipboard.writeText(txt);
        };
      });
    }
    histModal.style.display = 'flex';
    histModal.setAttribute('aria-hidden', 'false');
  }
  qs("#histMain").onclick   = ()=> openHistory("main");
  qs("#histKanban").onclick = ()=> openHistory("kanban");
</script>
</body>
</html>
