<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>311 • Materialistas Page</title>
  <!-- Conserva tu diseño -->
  <link rel="stylesheet" href="../style.css">
  <style>
    .center{ max-width:1080px; margin:18px auto; }
    .actions{ display:flex; gap:14px; justify-content:center; margin:18px 0 0; }
    .sep{ height:24px; }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="navbar">
    <a class="logo" id="goHome" href="javascript:void(0)">
      <img src="../img/logo.png" alt="Siemens">
    </a>
    <h1 class="title">MATERIALISTAS PAGE</h1>
    <button id="btnBack" class="btn btn-compact">VOLVER</button>
  </header>

  <main class="wrap">
    <h2 class="detalle-titulo" id="hdr">MATERIAL POR PEDIR EN 311</h2>

    <!-- Tabla lista principal -->
    <div class="center">
      <table class="tabla" id="tblR">
        <thead>
        <tr>
          <th>NÚMERO DE PARTE</th>
          <th>CANTIDAD</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="actions">
        <button id="copyR" class="btn btn-compact">COPIAR</button>
        <button id="clearR" class="btn btn-compact btn-danger">BORRAR 311</button>
      </div>
    </div>

    <!-- Separación visual -->
    <div class="sep"></div>

    <!-- Tabla KANBAN -->
    <div class="center">
      <h3 style="color:#fff;margin:0 0 10px 0;">KANBAN</h3>
      <table class="tabla" id="tblK">
        <thead>
        <tr>
          <th>NÚMERO DE PARTE</th>
          <th>CANTIDAD</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="actions">
        <button id="copyK" class="btn btn-compact">COPIAR</button>
        <button id="clearK" class="btn btn-compact btn-danger">BORRAR KANBAN</button>
      </div>
    </div>
  </main>

  <script type="module">
    const ROOT = '../';
    const { db } = await import(ROOT + 'firebase-config.js');
    import {
      collection, getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Usuario anónimo
    const USER_ID_KEY = 'mp_user';
    const userId = localStorage.getItem(USER_ID_KEY) || (()=>{ const id=crypto.randomUUID(); localStorage.setItem(USER_ID_KEY,id); return id; })();

    // Detectar KB y LINE
    const segs = location.pathname.split('/').filter(Boolean);     // .../<KB>/311.html
    const KB = segs[segs.length - 2] || 'HA';
    const params = new URLSearchParams(location.search);
    const LINE = (params.get('line') || 'L17').toUpperCase();

    // UI
    const hdr = document.getElementById('hdr');
    hdr.textContent = `MATERIAL POR PEDIR EN 311 — ${KB} / ${LINE}`;
    const goHome = document.getElementById('goHome');
    const btnBack = document.getElementById('btnBack');
    goHome.onclick = () => location.href = ROOT + 'index.html';
    btnBack.onclick = () => history.length>1 ? history.back() : location.href = './index.html';

    const tR = document.querySelector('#tblR tbody');
    const tK = document.querySelector('#tblK tbody');

    const copyR = document.getElementById('copyR');
    const clearR = document.getElementById('clearR');
    const copyK = document.getElementById('copyK');
    const clearK = document.getElementById('clearK');

    function inboxPath(type='regular'){
      return ['materialistapage','lines',KB,LINE,'inbox',userId,type];
    }

    async function loadTable(tbody, type='regular'){
      tbody.innerHTML = '';
      const qs = await getDocs(collection(db, ...inboxPath(type)));
      const rows = [];
      qs.forEach(d => rows.push(d.data()));
      rows.sort((a,b)=>(a.number||'').localeCompare(b.number||''));
      if (!rows.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="2" style="color:var(--muted)">Sin materiales.</td>`;
        tbody.appendChild(tr);
        return;
      }
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.number||''}</td><td>${r.qty||0}</td>`;
        tbody.appendChild(tr);
      }
    }

    function copyTable(tbody){
      const lines = [...tbody.querySelectorAll('tr')].map(tr=>{
        const c = tr.children;
        return (c.length>=2) ? `${c[0].textContent}\t${c[1].textContent}` : '';
      }).filter(Boolean).join('\n');
      if (!lines.trim()) { alert('No hay datos para copiar.'); return; }
      navigator.clipboard.writeText(lines).then(()=> alert('Copiado al portapapeles.'));
    }

    async function clearTable(type='regular'){
      if (!confirm('¿Borrar esta lista de la 311?')) return;
      const qs = await getDocs(collection(db, ...inboxPath(type)));
      for (const d of qs.docs){
        await deleteDoc(doc(db, ...inboxPath(type), d.id));
      }
      await loadAll();
    }

    async function loadAll(){
      await Promise.all([ loadTable(tR,'regular'), loadTable(tK,'kanban') ]);
    }

    copyR.onclick = () => copyTable(tR);
    copyK.onclick = () => copyTable(tK);
    clearR.onclick = () => clearTable('regular');
    clearK.onclick = () => clearTable('kanban');

    loadAll();
  </script>
</body>
</html>
