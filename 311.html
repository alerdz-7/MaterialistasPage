<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>311</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style-modelos.css"/>
  <style>
    .wrap{ max-width:1100px; margin:0 auto; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.05); }
    .qty{ text-align:right; width:160px }
    .actions{ display:flex; gap:10px; }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html"><img src="img/logo.png" alt="Logo"></a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="backBtn" type="button">VOLVER</button>
</header>

<main class="wrap">
  <h2 class="detalle-titulo" id="titleH2">MATERIAL POR PEDIR EN 311</h2>
  <div id="ctxHint" class="muted" style="text-align:center"></div>

  <div class="mat-card">
    <div class="mat-head">
      <h3>Material</h3>
      <div class="actions">
        <button class="btn" id="copyMain">Copiar</button>
        <button class="btn btn-danger" id="clearMain">Borrar</button>
      </div>
    </div>
    <table id="tblMain"><thead><tr><th>NÚMERO DE PARTE</th><th class="qty">CANTIDAD</th></tr></thead><tbody></tbody></table>
    <div id="emptyMain" class="muted" style="text-align:center; display:none">(Vacío)</div>
  </div>

  <div class="mat-card">
    <div class="mat-head">
      <h3>Kanban</h3>
      <div class="actions">
        <button class="btn" id="copyKanban">Copiar</button>
        <button class="btn btn-danger" id="clearKanban">Borrar</button>
      </div>
    </div>
    <table id="tblKanban"><thead><tr><th>NÚMERO DE PARTE</th><th class="qty">CANTIDAD</th></tr></thead><tbody></tbody></table>
    <div id="emptyKanban" class="muted" style="text-align:center; display:none">(Vacío)</div>
  </div>
</main>

<script type="module">
  // ---------- Contexto (KB y línea por querystring) ----------
  const p      = new URLSearchParams(location.search);
  const kb     = p.get("kb")   || "HA";
  const line   = p.get("line") || "L17";

  document.getElementById("backBtn").onclick = () => location.href = `${kb}/lineas/${line.toLowerCase()}.html`;
  document.getElementById("titleH2").textContent = `MATERIAL POR PEDIR EN 311 — ${kb} / ${line}`;

  // ---------- Almacenamiento local por dispositivo ----------
  const KEY = (kind)=> `MP311:${kb}:${line}:${kind}`; // kind: 'main' | 'kanban'

  function load(kind){
    try { return JSON.parse(localStorage.getItem(KEY(kind)) || "{}"); }
    catch { return {}; }
  }
  function save(kind, obj){
    localStorage.setItem(KEY(kind), JSON.stringify(obj || {}));
  }
  function clear(kind){
    localStorage.removeItem(KEY(kind));
  }

  // ---------- Render ----------
  const tbodyMain   = document.querySelector("#tblMain tbody");
  const tbodyKanban = document.querySelector("#tblKanban tbody");

  function paint(tbody, data){
    // data: { number: qty }
    const rows = Object.entries(data)
      .sort(([a],[b]) => String(a).localeCompare(String(b)))
      .map(([num,qty]) => `<tr><td>${num}</td><td class="qty">${Number(qty||0).toLocaleString("es-MX")}</td></tr>`)
      .join("");
    tbody.innerHTML = rows || "";
  }

  function refresh(){
    const main = load("main");
    const kanb = load("kanban");
    paint(tbodyMain,   main);
    paint(tbodyKanban, kanb);
    document.getElementById("emptyMain").style.display   = Object.keys(main).length ? "none" : "block";
    document.getElementById("emptyKanban").style.display = Object.keys(kanb).length ? "none" : "block";
  }

  // ---------- Copiar / Borrar ----------
  function toTSV(tbody){
    return Array.from(tbody.querySelectorAll("tr"))
      .map(tr => `${tr.children[0].textContent}\t${tr.children[1].textContent}`)
      .join("\n");
  }
  function copy(text){ navigator.clipboard.writeText(text); alert("Copiado."); }

  document.getElementById("copyMain").onclick   = ()=> copy(toTSV(tbodyMain));
  document.getElementById("copyKanban").onclick = ()=> copy(toTSV(tbodyKanban));

  document.getElementById("clearMain").onclick   = ()=>{ clear("main"); refresh(); };
  document.getElementById("clearKanban").onclick = ()=>{ clear("kanban"); refresh(); };

  // ---------- Inicio ----------
  refresh();
</script>
</body>
</html>
