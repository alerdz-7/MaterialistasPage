<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modelos ¬∑ L17</title>

  <!-- Ruta: HA/lineas/l17.html -->
  <link rel="stylesheet" href="../../style.css"/>
  <link rel="stylesheet" href="../../style-modelos.css"/>

  <style>
    /* Barra de acciones */
    .header-actions{ 
      display:flex; gap:14px; justify-content:center; margin:10px auto 18px; 
    }

    /* Grid de tarjetas de modelo */
    .grid{ 
      max-width:1180px; margin:0 auto; 
      display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); 
      gap:28px; 
    }

    /* Cada fila de modelo: el bot√≥n grande + los iconitos */
    .model-row{ 
      position:relative;              /* para posicionar los iconos dentro */
      display:flex; gap:8px; align-items:center;
    }
    .model-name{ width:100%; flex:1; }

    /* ===== Iconos flotantes (sin recuadro negro) ===== */
    .icon-btn, .add-btn{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      display:none;                   /* se muestran solo en los modos */
      border:none;
      background:transparent;         /* sin fondo */
      font-size:1.25rem;              /* tama√±o del √≠cono */
      line-height:1;
      cursor:pointer;
      padding:4px;
      z-index:2;
      user-select:none;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.25));
    }
    .icon-btn.del{ color:#e04f4f; }   /* rojo eliminar */
    .add-btn{ color:#1ee0a1; }        /* verde agregar */

    /* Mostrar seg√∫n modo activo */
    .mode-delete .icon-btn{ display:inline-flex; }
    .mode-plan   .add-btn{ display:inline-flex; }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="../../index.html" title="Ir al inicio">
    <img src="../../img/logo.png" alt="Logo">
  </a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="backBtn" type="button">VOLVER</button>
</header>

<main>
  <h2 class="detalle-titulo" id="pageTitle" style="text-align:center">MODELOS ¬∑ L√≠nea 17</h2>

  <div class="header-actions">
    <button class="btn btn-danger" id="btnDelete">ELIMINAR ALG√öN MODELO</button>
    <button class="btn" id="btnPlanToggle">PLAN DE HOY</button>
    <button class="btn" id="btnSeePlan">VER PLAN</button>
  </div>

  <section id="grid" class="grid" aria-live="polite"></section>
</main>

<!-- Botonera fija inferior derecha -->
<div class="fab-col" style="position:fixed;right:24px;bottom:24px;display:flex;flex-direction:column;gap:12px;">
  <button class="btn" id="btn311">311</button>
  <button class="btn" id="btnAdd">AGREGAR MODELO</button>
</div>

<script type="module" src="../../firebase-config.js"></script>
<script type="module">
  import { db } from "../../firebase-config.js";
  import {
    collection, doc, onSnapshot, query, orderBy,
    deleteDoc, getDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  /* ====== Contexto KB/L√≠nea ====== */
  const KB_ID   = "HA";
  const LINE_ID = "L17";

  /* ====== Elementos ====== */
  const grid          = document.getElementById("grid");
  const btnBack       = document.getElementById("backBtn");
  const btnDelete     = document.getElementById("btnDelete");
  const btnPlanToggle = document.getElementById("btnPlanToggle");
  const btnSeePlan    = document.getElementById("btnSeePlan");
  const btn311        = document.getElementById("btn311");
  const btnAdd        = document.getElementById("btnAdd");
  const page          = document.body;

  /* ====== Navegaci√≥n ====== */
  btnBack.onclick    = () => location.href = "../index.html"; // HA/lineas/index.html
  btnSeePlan.onclick = () => location.href = `../../plan.html?kb=${KB_ID}&line=${LINE_ID}`;
  btn311.onclick     = () => location.href = `../../311.html?kb=${KB_ID}&line=${LINE_ID}`;
  btnAdd.onclick     = () => location.href = `../../nuevomodelo.html?kb=${KB_ID}&line=${LINE_ID}`;

  /* ====== Modos ====== */
  let deleteMode = false;
  let planMode   = false;

  function applyModes(){
    page.classList.toggle("mode-delete", deleteMode);
    page.classList.toggle("mode-plan",   planMode);

    btnDelete.textContent   = deleteMode ? "CANCELAR ELIMINAR" : "ELIMINAR ALG√öN MODELO";
    btnPlanToggle.textContent = planMode ? "LISTO EL PLAN DE HOY" : "PLAN DE HOY";
  }
  btnDelete.onclick     = () => { deleteMode = !deleteMode; if (deleteMode) planMode=false; applyModes(); };
  btnPlanToggle.onclick = () => { planMode   = !planMode;   if (planMode)   deleteMode=false; applyModes(); };

  /* ====== Render ====== */
  function render(items){
    grid.innerHTML = items.length
      ? items.map(m => `
        <div class="model-row">
          <button class="grid-btn model-name" data-id="${m.id}" data-name="${(m.name||m.display||'').replace(/"/g,'&quot;')}">
            ${m.name || m.display || "(Sin nombre)"}
          </button>

          <!-- Icono verde para agregar al plan (solo en modo plan) -->
          <button class="add-btn" title="Agregar al plan" data-id="${m.id}" data-name="${(m.name||m.display||'').replace(/"/g,'&quot;')}">Ôºã</button>

          <!-- Icono rojo para eliminar (solo en modo eliminar) -->
          <button class="icon-btn del" title="Eliminar" data-id="${m.id}">üóëÔ∏è</button>
        </div>`).join("")
      : `<button class="grid-btn" disabled style="opacity:.7">(Sin modelos a√∫n)</button>`;
  }

  /* ====== Lectura de modelos (esquema nuevo + fallback legado) ====== */
  onSnapshot(
    query(collection(db, "KB", KB_ID, "lines", LINE_ID, "models"), orderBy("display","asc")),
    snap => {
      if (!snap.empty) {
        const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
        render(arr);
      } else {
        grid.innerHTML = `<button class="grid-btn" disabled style="opacity:.7">(Sin modelos a√∫n)</button>`;
      }
    }
  );
  // Fallback legacy si no existiera el esquema nuevo
  onSnapshot(
    query(collection(db, "lines", LINE_ID, "models"), orderBy("display","asc")),
    snap => {
      if (grid.childElementCount === 0 && !snap.empty) {
        const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
        render(arr);
      }
    }
  );

  /* ====== Util ====== */
  const todayKey = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };

  /* ====== Clicks en la lista ====== */
  grid.addEventListener("click", async (ev)=>{
    const nameBtn = ev.target.closest(".model-name");
    const delBtn  = ev.target.closest(".del");
    const addBtn  = ev.target.closest(".add-btn");

    // Abrir modelo (solo si no estamos en modos especiales)
    if (nameBtn && !deleteMode && !planMode){
      const id = nameBtn.dataset.id;
      location.href = `../../modelo.html?kb=${KB_ID}&line=${LINE_ID}&id=${id}`;
      return;
    }

    // Eliminar un modelo (modo eliminar)
    if (delBtn && deleteMode){
      const id = delBtn.dataset.id;
      const confirmName = delBtn.parentElement.querySelector(".model-name")?.dataset?.name || "modelo";
      if (!confirm(`¬øEliminar ‚Äú${confirmName}‚Äù? Esta acci√≥n no se puede deshacer.`)) return;

      // Borrar en esquema nuevo (si existe)
      try { await deleteDoc(doc(db, "KB", KB_ID, "lines", LINE_ID, "models", id)); } catch {}
      // Borrar en legacy (si existe)
      try { await deleteDoc(doc(db, "lines", LINE_ID, "models", id)); } catch {}
      return;
    }

    // Agregar al plan del d√≠a (modo plan)
    if (addBtn && planMode){
      const modelId = addBtn.dataset.id;
      const name    = addBtn.dataset.name;
      const today   = todayKey();

      // Documento del plan donde plan.html espera items[]
      const planRef = doc(db, "KB", KB_ID, "lines", LINE_ID, "plans", today);

      try {
        const snap = await getDoc(planRef);
        let items = [];
        if (snap.exists()) {
          const data = snap.data() || {};
          items = Array.isArray(data.items) ? data.items : [];
        }
        // Agrega el modelo (qty se asigna despu√©s en plan.html)
        items.push({ id: modelId, name, qty: 0, done: false });

        await setDoc(planRef, { items }, { merge: true });

        // Respaldo local para abrir plan.html de inmediato si falla la red
        try { localStorage.setItem(`MPPLAN:${KB_ID}:${LINE_ID}:${today}`, JSON.stringify(items)); } catch {}
        alert(`‚Äú${name}‚Äù agregado al plan de hoy.`);
      } catch (e) {
        console.error(e);
        alert("No se pudo agregar al plan. Revisa tu conexi√≥n e int√©ntalo nuevamente.");
      }
      return;
    }
  });
</script>
</body>
</html>
