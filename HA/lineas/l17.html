<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MODELOS ¬∑ L√≠nea 17</title>

  <!-- Tus estilos (no se tocan colores/fuentes) -->
  <link rel="stylesheet" href="../../style.css"/>
  <link rel="stylesheet" href="../../style-modelos.css"/>

  <style>
    /* Centrado + espacio al fondo para no tapar √∫ltimos modelos por los FAB derechos */
    .wrap { max-width:1200px; margin:0 auto; padding:0 12px; }
    .grid {
      display:grid; grid-template-columns:repeat(3,1fr); gap:18px;
      max-width:1000px; margin:0 auto;
      padding-bottom:220px; /* deja pasar los √∫ltimos botones */
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .top-actions { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:16px 0 18px; }

    /* FAB derecho abajo */
    .fab-right {
      position:fixed; right:12px; bottom:12px; z-index:100;
      display:flex; flex-direction:column; gap:10px;
    }
    .fab-right .grid-btn, .fab-right .btn-agregar {
      min-width:160px; text-align:center;
      box-shadow:0 8px 20px rgba(0,0,0,.28);
      border:2px solid rgba(255,255,255,.9);
    }
    @media (max-width: 760px){ .fab-right{ right:8px; bottom:8px; gap:8px; } }

    /* Fila de modelo con iconos laterales (+ / üóëÔ∏è) */
    .row { position:relative; display:flex; align-items:center; }
    .row .grid-btn { flex:1; } /* tu bot√≥n original */

    .side-icons {
      position:absolute; right:10px; display:flex; gap:8px; pointer-events:none;
    }
    .icon-btn {
      width:38px; height:38px; border:none; border-radius:10px;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.18); backdrop-filter:blur(2px);
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      pointer-events:auto; cursor:pointer;
    }
    .mode-plan   .icon-add { display:flex; }
    .mode-delete .icon-del { display:flex; }
    .icon-btn svg { width:22px; height:22px; }
    .icon-add svg { color:#26d39f; }  /* + */
    .icon-del svg { color:#ff6b6b; }  /* üóëÔ∏è */

    /* üí¨ arriba del contador (no encima) */
    :root{ --boxes-h:120px; --boxes-gap:12px; }
    .chat-fab{ position:fixed; left:16px; z-index:9999; }
    @media (min-width: 841px){ .chat-fab{ bottom:16px !important; } }
    @media (max-width: 840px){ .chat-fab{ bottom: calc(16px + var(--boxes-h) + var(--boxes-gap)) !important; } }

    /* Contador de cajas m√°s peque√±o en m√≥vil (sin cambiar colores) */
    @media (max-width: 840px){
      .boxes-fab { transform: scale(.88); transform-origin: left bottom; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="navbar">
    <a class="logo" href="../../index.html"><img src="../../img/logo.png" alt="Logo"></a>
    <h1 class="title">MATERIALISTAS PAGE</h1>
    <button class="btn-agregar" id="btnBack" type="button">VOLVER</button>
  </header>

  <main class="wrap">
    <h2 class="detalle-titulo" id="pageTitle" style="text-align:center">MODELOS ¬∑ L√≠nea 17</h2>

    <div class="top-actions">
      <button class="grid-btn btn-danger" id="btnDelete">ELIMINAR ALG√öN MODELO</button>
      <button class="grid-btn" id="btnPlan">PLAN DE HOY</button>
      <button class="grid-btn" id="btnVerPlan">VER PLAN</button>
    </div>

    <section id="models" class="grid" aria-live="polite"></section>
  </main>

  <!-- FAB derecho (abajo) -->
  <aside class="fab-right" aria-label="Acciones r√°pidas">
    <button class="grid-btn" id="btnRetorno">RETORNO</button>
    <button class="grid-btn" id="btn311">311</button>
    <button class="grid-btn" id="btnAdd">AGREGAR MODELO</button>
  </aside>

  <!-- Firebase -->
  <script type="module" src="../../firebase-config.js"></script>

  <script type="module">
    import { db } from "../../firebase-config.js";
    import {
      collection, query, orderBy, onSnapshot, doc, deleteDoc,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    /* ===== Par√°metros ===== */
    const p    = new URLSearchParams(location.search);
    const KB   = (p.get("kb")   || "HA").trim();
    const LINE = (p.get("line") || "L17").trim();

    /* ===== Navegaci√≥n ===== */
    $("#pageTitle").textContent = `MODELOS ¬∑ ${LINE.replace(/^L/i,'L√≠nea ')}`;
    $("#btnBack").onclick    = () => history.length>1 ? history.back() : (location.href="../../index.html");
    $("#btnVerPlan").onclick = () => location.href = `../../plan.html?kb=${encodeURIComponent(KB)}&line=${encodeURIComponent(LINE)}`;
    $("#btnRetorno").onclick = () => location.href = `../../retorno.html?kb=${encodeURIComponent(KB)}&line=${encodeURIComponent(LINE)}`;
    $("#btn311").onclick     = () => location.href = `../../311.html?kb=${encodeURIComponent(KB)}&line=${encodeURIComponent(LINE)}`;
    $("#btnAdd").onclick     = () => location.href = `../../nuevomodelo.html?kb=${encodeURIComponent(KB)}&line=${encodeURIComponent(LINE)}`;

    let deleteMode = false;
    $("#btnDelete").onclick = ()=>{
      deleteMode = !deleteMode;
      document.body.classList.toggle("mode-delete", deleteMode);
    };
    $("#btnPlan").onclick = ()=>{
      document.body.classList.toggle("mode-plan");
      // no notificaciones ni redirecciones
    };

    /* ===== Util ===== */
    const todayKey = () => {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };
    const planRef = () => doc(db, "KB", KB, "lines", LINE, "plans", todayKey());

    async function addToTodayPlan(modelId, name){
      // Transacci√≥n: si existe el modelo, incrementa qty; si no, lo agrega
      await runTransaction(db, async (tx)=>{
        const ref = planRef();
        const snap = await tx.get(ref);
        let items = (snap.exists() && Array.isArray(snap.data().items)) ? [...snap.data().items] : [];
        const i = items.findIndex(it => (it.id||it.modelId) === modelId);
        if (i >= 0){
          const cur = Number(items[i].qty || 0);
          items[i] = { ...items[i], qty: cur + 1 };
        } else {
          items.push({ id: modelId, name: name || modelId, qty: 1, done: false });
        }
        tx.set(ref, { items }, { merge: true });
      });
      // sin alertas / notificaciones
    }

    /* ===== Render de modelos (tu bot√≥n .grid-btn NO cambia) ===== */
    const list = $("#models");
    const qy = query(collection(db, "KB", KB, "lines", LINE, "models"), orderBy("display","asc"));

    onSnapshot(qy, snap=>{
      const items = snap.docs.map(d=>({id:d.id, ...(d.data()||{})}));
      if (!items.length){
        list.innerHTML = `<div style="grid-column:1/-1; text-align:center; opacity:.8">No hay modelos en esta l√≠nea.</div>`;
        return;
      }
      list.innerHTML = items.map(m=>{
        const id = m.id, name = m.display || m.name || id;
        return `
          <div class="row">
            <button class="grid-btn" data-id="${id}" data-name="${name}">${name}</button>
            <div class="side-icons">
              <!-- + -->
              <button class="icon-btn icon-add" title="Agregar al plan" data-id="${id}" data-name="${name}">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z"/>
                </svg>
              </button>
              <!-- üóëÔ∏è -->
              <button class="icon-btn icon-del" title="Eliminar modelo" data-id="${id}">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v8h-2V9zm4 0h2v8h-2V9z"/>
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join("");
    });

    /* Clicks */
    document.addEventListener("click", async (e)=>{
      const add = e.target.closest(".icon-add");
      const del = e.target.closest(".icon-del");
      const btn = e.target.closest(".grid-btn[data-id]");

      if (add){
        const id   = add.dataset.id;
        const name = add.dataset.name;
        await addToTodayPlan(id, name); // agrega directo, sin abrir p√°gina y sin alertas
        return;
      }
      if (del){
        if (!confirm("¬øEliminar este modelo de la l√≠nea?")) return;
        const id = del.dataset.id;
        try{ await deleteDoc(doc(db, "KB", KB, "lines", LINE, "models", id)); }catch(_){}
        return;
      }
      if (btn && !document.body.classList.contains("mode-plan") && !document.body.classList.contains("mode-delete")){
        const id = btn.dataset.id;
        location.href = `../../modelo.html?kb=${encodeURIComponent(KB)}&line=${encodeURIComponent(LINE)}&id=${encodeURIComponent(id)}`;
      }
    });

    /* ===== Ajuste del üí¨ respecto al contador (medimos la altura real del widget) ===== */
    function updateBoxesVar(){
      const el = document.querySelector(".boxes-fab");
      if (!el) return;
      const h = Math.round(el.getBoundingClientRect().height || 120);
      document.documentElement.style.setProperty("--boxes-h", h + "px");
    }
    const mo = new MutationObserver(updateBoxesVar);
    mo.observe(document.body, { childList:true, subtree:true });
    window.addEventListener("resize", updateBoxesVar);
  </script>

  <!-- Widgets (respetan tus estilos) -->
  <script type="module" src="../../comentario-widget.js"></script>
  <script type="module" src="../../cajas-widget.js"></script>
  <!-- FIX puntual: separar üí¨ del widget de cajas y asegurar la fila input+Guardar -->
<style id="fix-widgets-css">
  /* Fuerza que input y bot√≥n vivan en la misma fila dentro del recuadro */
  .boxes-row{
    display:grid !important;
    grid-template-columns: 1fr max-content !important;
    column-gap:8px !important;
    align-items:center !important;
  }
</style>

<script>
(function(){
  /* Espacio extra entre el panel de cajas y el bot√≥n üí¨ (en laptop/desktop) */
  const GAP = 22; // px

  function placeCommentFab(){
    const fab  = document.querySelector(".chat-fab");   // contenedor del bot√≥n üí¨
    const boxW = document.querySelector(".boxes-fab");  // contenedor del widget de cajas
    if (!fab || !boxW) return;

    const h = Math.round(boxW.getBoundingClientRect().height || 120);
    // Forzamos bottom para ganar a cualquier regla previa que te est√© pisando
    fab.style.setProperty("bottom", (16 + h + GAP) + "px", "important");
    fab.style.setProperty("left",   "16px",             "important");
    fab.style.setProperty("z-index","1000",             "important");
  }

  // Colocar al cargar
  placeCommentFab();

  // Recolocar en cambios de tama√±o/orientaci√≥n
  window.addEventListener("resize", placeCommentFab);
  window.addEventListener("orientationchange", placeCommentFab);

  // Recolocar cuando el widget de cajas cambia de tama√±o o aparece
  const ro = new ResizeObserver(placeCommentFab);
  const observeBoxes = () => {
    const el = document.querySelector(".boxes-fab");
    if (el) ro.observe(el);
  };
  observeBoxes();

  // Si los widgets emiten eventos, los escuchamos tambi√©n
  window.addEventListener("boxes:ready",  placeCommentFab);
  window.addEventListener("boxes:resize", placeCommentFab);

  // Reintentos breves por si el DOM tarda
  let tries = 0;
  const t = setInterval(()=>{ placeCommentFab(); observeBoxes(); if(++tries>8) clearInterval(t); }, 300);
})();
</script>

</body>
</html>
