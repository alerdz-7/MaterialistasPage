<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modelos ¬∑ L17</title>

  <!-- Estilos globales existentes -->
  <link rel="stylesheet" href="../../style.css" />
  <link rel="stylesheet" href="../../style-modelos.css" />

  <style>
    /* Mantener look & feel actual y centrar correctamente */
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 80px;
    }
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .page-title {
      flex: 1;
      text-align: center;
      font-size: 34px;
      letter-spacing: .5px;
      margin: 24px 0 10px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: center;
      margin: 8px 0 26px;
      flex-wrap: wrap;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap: 28px 36px;
      align-items: stretch;
    }
    .model-card {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--btn-teal, #0d9488);
      border-radius: 14px;
      height: 72px;
      cursor: pointer;
      box-shadow: 0 6px 0 rgba(0,0,0,.35);
      border: 2px solid rgba(0,0,0,.35);
      transition: transform .06s ease;
      user-select: none;
    }
    .model-card:active { transform: translateY(2px); }
    .model-card span {
      font-weight: 700;
      color: #021c1c;
      text-shadow: 0 1px 0 rgba(255,255,255,.2);
    }
    /* Bot√≥n + para modo plan */
    .add-pill {
      position: absolute;
      right: -10px;
      top: -12px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,.35);
      box-shadow: 0 6px 0 rgba(0,0,0,.35);
      display: none;             /* oculto por defecto */
      align-items: center;
      justify-content: center;
      background: #16a34a;       /* verde ok */
      color: #021c1c;
      font-weight: 800;
      cursor: pointer;
    }
    .add-pill:active { transform: translateY(2px); }
    .add-mode .add-pill { display: flex; }   /* visible en modo plan */

    /* Botones de la toolbar (heredan tu estilo base) */
    .btn-danger { background:#b4232a; }
    .btn-outline { background:#0c3942; border:2px solid rgba(0,0,0,.35); }

    /* Pie fijo con acciones r√°pidas */
    .fab-col {
      position: fixed;
      right: 24px;
      bottom: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 10;
    }

    /* Responsive */
    @media (max-width: 980px) {
      .grid { grid-template-columns: repeat(2,minmax(220px,1fr)); }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .page-title { font-size: 28px; }
    }
  </style>
</head>
<body>
  <!-- Barra superior (respetando tu dise√±o) -->
  <header class="navbar">
    <a class="logo" href="../../index.html" aria-label="Ir al inicio"></a>
    <h1 class="brand">MATERIALISTAS PAGE</h1>
    <button class="btn" id="btnBack" onclick="history.length ? history.back() : (location.href='../../index.html')">VOLVER</button>
  </header>

  <main class="page">
    <div class="page-header">
      <h2 class="page-title">MODELOS ¬∑ L√≠nea 17</h2>
    </div>

    <!-- Barra de acciones -->
    <div class="toolbar">
      <button class="btn btn-danger" id="btnToggleDelete">ELIMINAR ALG√öN MODELO</button>
      <button class="btn" id="btnPlanMode">‚ûï PLAN DE HOY</button>
      <button class="btn btn-outline" id="btnSeePlan">üóìÔ∏è VER PLAN</button>
    </div>

    <!-- Listado de modelos -->
    <section id="grid" class="grid"></section>
  </main>

  <!-- FABs iguales a los tuyos (311 y agregar modelo) -->
  <div class="fab-col">
    <button class="btn" id="btn311">311</button>
    <button class="btn" id="btnAddModel">AGREGAR MODELO</button>
  </div>

  <!-- Firebase + l√≥gica -->
  <script type="module">
    /********** Firebase **********/
    import { db } from '../../firebase-config.js';
    import {
      collection, doc, getDocs, getDoc, setDoc, runTransaction,
      serverTimestamp, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    /********** Constantes de la l√≠nea (L17) **********/
    const KB = 'HA';
    const LINE_ID = 'L17';

    /********** Utilidades **********/
    const $ = s => document.querySelector(s);
    const grid = $('#grid');

    // YYYY-MM-DD local
    function todayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // Navegaci√≥n
    $('#btnSeePlan').addEventListener('click', () => {
      location.href = `../../plan.html?kb=${KB}&line=${LINE_ID}`;
    });
    $('#btn311').addEventListener('click', () => {
      location.href = `../../311.html?kb=${KB}&line=${LINE_ID}`;
    });
    $('#btnAddModel').addEventListener('click', () => {
      location.href = `../../nuevomodelo.html?kb=${KB}&line=${LINE_ID}`;
    });

    /********** Carga de modelos **********/
    async function loadModels() {
      grid.innerHTML = '';
      const modelsCol = collection(db, 'lines', LINE_ID, 'models');
      // Si tienes un campo "display" o "createdAt", ord√©nalo; si no, quita orderBy
      let qRef;
      try {
        qRef = query(modelsCol, orderBy('createdAt', 'asc'));
      } catch {
        qRef = modelsCol; // fallback
      }
      const snap = await getDocs(qRef);
      if (snap.empty) {
        grid.innerHTML = '<p style="opacity:.7; grid-column:1/-1">Sin modelos a√∫n.</p>';
        return;
      }
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const display = data.display || id;

        const card = document.createElement('div');
        card.className = 'model-card';
        card.setAttribute('data-id', id);
        card.setAttribute('data-display', display);

        // Click a modelo: ir a modelo.html
        card.addEventListener('click', (ev) => {
          // si el click vino del "+" no navegamos
          if (ev.target && ev.target.classList.contains('add-pill')) return;
          location.href = `../../modelo.html?kb=${KB}&line=${LINE_ID}&model=${encodeURIComponent(id)}`;
        });

        // Texto del bot√≥n
        const span = document.createElement('span');
        span.textContent = display;
        card.appendChild(span);

        // Bot√≥n + (se muestra solo en modo plan)
        const add = document.createElement('button');
        add.className = 'add-pill';
        add.title = 'Agregar este modelo al plan de hoy';
        add.textContent = '+';
        add.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          await addModelToTodayPlan({ modelId: id, display });
        });
        card.appendChild(add);

        grid.appendChild(card);
      });
    }

    /********** Modo plan: mostrar/ocultar el "+" **********/
    let addMode = false;
    const btnPlanMode = $('#btnPlanMode');
    btnPlanMode.addEventListener('click', () => {
      addMode = !addMode;
      grid.classList.toggle('add-mode', addMode);
      btnPlanMode.textContent = addMode ? '‚úîÔ∏è LISTO EL PLAN DE HOY' : '‚ûï PLAN DE HOY';
    });

    /********** Alta en el plan del d√≠a **********/
    async function addModelToTodayPlan({ modelId, display }) {
      const planId = todayKey();
      const planRef = doc(db, 'lines', LINE_ID, 'plans', planId);

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(planRef);
        let items = [];
        if (snap.exists()) {
          items = Array.isArray(snap.data().items) ? [...snap.data().items] : [];
        }
        // Evitar duplicados
        if (!items.some(it => it.modelId === modelId)) {
          items.push({
            modelId,
            display,
            order: Date.now(),                 // para mantener orden de agregado
            createdAt: serverTimestamp()
          });
        }
        tx.set(planRef, {
          items,
          dateKey: planId,
          updatedAt: serverTimestamp()
        }, { merge: true });
      });

      // feedback visual m√≠nimo
      const el = grid.querySelector(`.model-card[data-id="${CSS.escape(modelId)}"]`);
      if (el) {
        el.style.outline = '3px solid #16a34a';
        setTimeout(()=>{ el.style.outline = 'none'; }, 500);
      }
    }

    /********** Eliminar alg√∫n modelo (visual, como lo ten√≠as) **********/
    let deleteMode = false;
    $('#btnToggleDelete').addEventListener('click', () => {
      deleteMode = !deleteMode;
      if (!deleteMode) {
        // salir de modo eliminar
        const dels = grid.querySelectorAll('.trash-pill');
        dels.forEach(b => b.remove());
        return;
      }
      // A√±adir pill de eliminar a cada card
      grid.querySelectorAll('.model-card').forEach(card => {
        if (card.querySelector('.trash-pill')) return;
        const trash = document.createElement('button');
        trash.className = 'trash-pill';
        trash.style.cssText = `
          position:absolute; left:-10px; top:-12px; width:40px; height:40px; border-radius:50%;
          border:2px solid rgba(0,0,0,.35); box-shadow:0 6px 0 rgba(0,0,0,.35);
          background:#b4232a; color:#fff; font-weight:800; cursor:pointer;
        `;
        trash.textContent = 'üóëÔ∏è';
        trash.title = 'Eliminar modelo';
        trash.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          const id = card.getAttribute('data-id');
          if (!confirm(`¬øEliminar el modelo "${card.getAttribute('data-display')}"?`)) return;
          await deleteModel(id);
          card.remove();
        });
        card.appendChild(trash);
      });
    });

    async function deleteModel(modelId) {
      // No borro aqu√≠ por seguridad (porque puede haber documentos dependientes).
      // Si ya tienes l√≥gica de borrado en otra parte, ll√°mala desde aqu√≠.
      // Ejemplo para borrar el doc del modelo:
      // const ref = doc(db, 'lines', LINE_ID, 'models', modelId);
      // await deleteDoc(ref);
      alert('El borrado del modelo se dej√≥ intencionalmente deshabilitado por seguridad.\nIntegra tu rutina de borrado si ya la tienes lista.');
    }

    /********** Start **********/
    loadModels();
  </script>
</body>
</html>
