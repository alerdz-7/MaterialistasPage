<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modelo</title>

  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style-modelos.css"/>

  <style>
    #qtyInput{ width:92px; text-align:center; font-weight:700; letter-spacing:1px; }
    .table-wrap{ max-width:1100px; margin:0 auto; }
    .tbl thead th{ white-space:nowrap; }
    .tbl td,.tbl th{ text-align:left; }
    .tbl td.num,.tbl th.num{ text-align:center; }
    .mini{ opacity:.85; font-size:.9rem }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html" title="Ir al inicio">
    <img src="img/logo.png" alt="Logo">
  </a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="btnBack" type="button">VOLVER</button>
</header>

<main class="table-wrap">
  <h2 id="modelTitle" class="detalle-titulo">MODELO</h2>

  <div style="display:flex; align-items:center; gap:14px; justify-content:center; margin:12px 0 18px;">
    <span class="mini">INGRESA CANTIDAD</span>
    <input id="qtyInput" type="number" inputmode="numeric" min="0" step="1" value="0"/>
    <button class="btn btn-compact" id="btnToggleAll">MARCAR TODO</button>
    <button class="btn btn-compact" id="btnEdit">EDITAR MODELO</button>
  </div>

  <div class="tabla tbl">
    <table>
      <thead>
      <tr>
        <th style="width:30%">MATERIAL</th>
        <th style="width:30%">NÚMERO DE PARTE</th>
        <th class="num" style="width:10%">FACTOR</th>
        <th class="num" style="width:15%">CANTIDAD</th>
        <th class="num" style="width:15%">PEDIR</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div style="display:flex; justify-content:center; margin:22px 0 54px;">
    <button class="btn" id="btnOk" type="button">OK</button>
  </div>
</main>

<!-- Firebase -->
<script type="module" src="firebase-config.js"></script>
<script type="module">
  import { db } from "./firebase-config.js";
  import { doc, getDoc, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // --------- Utilidades ---------
  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const numberFormat = n => (n||0).toLocaleString('es-MX');
  const params = (()=>{ const p=new URLSearchParams(location.search); return { kb:p.get('kb')||'HA', line:p.get('line')||'L17', id:p.get('id')||'' }; })();

  // 311 local separada
  const key311 = (kb,line,kind)=> `MP311:${kb}:${line}:${kind}`;
  const load311 = (kb,line,kind)=> { try{ return JSON.parse(localStorage.getItem(key311(kb,line,kind))||'{}'); } catch{ return{} } };
  const save311 = (kb,line,kind,obj)=> localStorage.setItem(key311(kb,line,kind), JSON.stringify(obj||{}));

  function normalizeName(s=''){ return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
  function isKanbanName(name=''){ const n = normalizeName(name); return /\bbase\b/.test(n) || /\btapa\b/.test(n); }

  // --------- Estado ---------
  const titleEl = qs('#modelTitle');
  const rowsEl  = qs('#rows');
  const qtyEl   = qs('#qtyInput');

  let modelDoc = null;
  let materials = [];  // {name, number, factor}

  // --------- Carga del modelo (con fallback) ---------
  async function loadModel(){
    const refKB  = doc(db, 'KB', params.kb, 'lines', params.line, 'models', params.id);
    const snapKB = await getDoc(refKB);
    if (snapKB.exists()){ modelDoc = snapKB; }
    else {
      const refLegacy= doc(db, 'lines', params.line, 'models', params.id);
      const snapLegacy= await getDoc(refLegacy);
      if (snapLegacy.exists()) modelDoc = snapLegacy;
    }

    if (!modelDoc){
      titleEl.textContent = 'MODELO (no encontrado)';
      rowsEl.innerHTML = `<tr><td colspan="5" style="text-align:center; opacity:.75">No se encontró información del modelo.</td></tr>`;
      return;
    }

    const data = modelDoc.data() || {};
    titleEl.textContent = (data.name || data.display || 'MODELO').toUpperCase();

    materials = Array.isArray(data.materials) ? data.materials.slice() : [];
    if (!materials.length){
      // respaldo vía subcolección "materials"
      const refBasePath = modelDoc.ref.path.split('/');
      const col = collection(db, ...refBasePath, 'materials');
      const q  = query(col, orderBy('name','asc'));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const m = d.data() || {};
        materials.push({ name:m.name||'', number:m.number||'', factor:Number(m.factor||0) });
      });
    }
    renderRows();
    updateQuantities();
  }

  // --------- Render de filas ---------
  function renderRows(){
    if (!materials.length){
      rowsEl.innerHTML = `<tr><td colspan="5" style="text-align:center; opacity:.75">Este modelo no tiene materiales registrados.</td></tr>`;
      return;
    }
    rowsEl.innerHTML = materials.map((m,idx) => `
      <tr data-idx="${idx}">
        <td>${m.name || ''}</td>
        <td>${m.number || ''}</td>
        <td class="num">${Number(m.factor||0)}</td>
        <td class="num"><span class="qty" data-raw="0">0</span></td>
        <td class="num"><input type="checkbox" class="chk-ask" aria-label="Pedir ${m.name || ''}"></td>
      </tr>
    `).join('');
  }

  // --------- Cálculo de cantidades ---------
  function updateQuantities(){
    const baseQty = Math.max(0, Number(qtyEl.value || 0));
    qsa('#rows tr').forEach(tr => {
      const idx   = Number(tr.dataset.idx || 0);
      const f     = Number(materials[idx]?.factor || 0);
      const total = baseQty * f;
      const cell  = tr.querySelector('.qty');
      if (cell){ cell.dataset.raw = String(total); cell.textContent = numberFormat(total); }
    });
  }

  // --------- Marcar todo ---------
  let allMarked = false;
  function toggleAll(){ allMarked = !allMarked; qsa('.chk-ask').forEach(chk => chk.checked = allMarked); }

  // --------- OK => manda SELECCIONADOS a 311 (LOCAL por dispositivo) ---------
  async function sendTo311(){
    const baseQty = Math.max(0, Number(qtyEl.value || 0));
    if (!materials.length || baseQty <= 0){ alert('Ingresa una cantidad mayor a 0.'); return; }

    // acumula por número en main/kanban según nombre
    let storeMain   = load311(params.kb, params.line, 'main');
    let storeKanban = load311(params.kb, params.line, 'kanban');

    qsa('#rows tr').forEach(tr => {
      const idx  = Number(tr.dataset.idx || 0);
      const ask  = tr.querySelector('.chk-ask')?.checked;
      if (!ask) return;

      const name = materials[idx]?.name || '';
      const part = (materials[idx]?.number || '').trim();
      const add  = Number(tr.querySelector('.qty')?.dataset.raw || 0);
      if (!part || add <= 0) return;

      const isKan = isKanbanName(name);
      const bucket = isKan ? storeKanban : storeMain;
      bucket[part] = Number(bucket[part]||0) + add;

      if (isKan) storeKanban = bucket; else storeMain = bucket;
    });

    save311(params.kb, params.line, 'main',   storeMain);
    save311(params.kb, params.line, 'kanban', storeKanban);

    alert('Material agregado a 311.');
  }

  // --------- Navegación ---------
  qs('#btnBack').onclick = () => history.length > 1 ? history.back() : (location.href = 'index.html');
  qs('#btnEdit').onclick = () => {
    location.href = `nuevomodelo.html?mode=edit&kb=${params.kb}&line=${params.line}&id=${params.id}`;
  };

  // --------- Eventos ---------
  qtyEl.addEventListener('input', updateQuantities);
  qs('#btnToggleAll').addEventListener('click', toggleAll);
  qs('#btnOk').addEventListener('click', sendTo311);

  // Arranque
  loadModel();
</script>
</body>
</html>
