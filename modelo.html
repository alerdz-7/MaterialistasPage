<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modelo</title>

  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style-modelos.css"/>

  <style>
    #qtyInput{ width:92px; text-align:center; font-weight:700; letter-spacing:1px; }
    .table-wrap{ max-width:1100px; margin:0 auto; padding:0 12px; }
    .tbl thead th{ white-space:nowrap; }
    .tbl td,.tbl th{ text-align:left; }
    .tbl td.num,.tbl th.num{ text-align:center; }
    .mini{ opacity:.85; font-size:.9rem }
  </style>
</head>
<body>
<header class="navbar">
  <a class="logo" href="index.html" title="Ir al inicio">
    <img src="img/logo.png" alt="Logo">
  </a>
  <h1 class="title">MATERIALISTAS PAGE</h1>
  <button class="btn-agregar" id="btnBack" type="button">VOLVER</button>
</header>

<main class="table-wrap">
  <h2 id="modelTitle" class="detalle-titulo">MODELO</h2>

  <div style="display:flex; align-items:center; gap:14px; justify-content:center; margin:12px 0 18px;">
    <span class="mini">INGRESA CANTIDAD</span>
    <input id="qtyInput" type="number" inputmode="numeric" min="0" step="1" value="0"/>
    <button class="btn btn-compact" id="btnToggleAll">MARCAR TODO</button>
    <button class="btn btn-compact" id="btnEdit">EDITAR MODELO</button>
  </div>

  <div class="tabla tbl">
    <table>
      <thead>
      <tr>
        <th style="width:30%">MATERIAL</th>
        <th style="width:30%">NÃšMERO DE PARTE</th>
        <th class="num" style="width:10%">FACTOR</th>
        <th class="num" style="width:15%">CANTIDAD</th>
        <th class="num" style="width:15%">PEDIR</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div style="display:flex; justify-content:center; margin:22px 0 54px;">
    <button class="btn" id="btnOk" type="button">OK</button>
  </div>
</main>

<script type="module" src="firebase-config.js"></script>
<script type="module">
  import { db } from "./firebase-config.js";
  import {
    doc, onSnapshot, collection, query, orderBy, onSnapshot as colSnapshot,
    setDoc, increment, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const qs  = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const nf  = n => (n||0).toLocaleString('es-MX');

  const params = (()=>{ const p=new URLSearchParams(location.search); return { kb:p.get('kb')||'HA', line:p.get('line')||'L17', id:p.get('id')||'' }; })();

  const SID_KEY = "materialistas.sessionId";
  let sessionId = localStorage.getItem(SID_KEY);
  if (!sessionId){ sessionId = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sessionId); }

  // ---- Estado ----
  const titleEl = qs('#modelTitle');
  const rowsEl  = qs('#rows');
  const qtyEl   = qs('#qtyInput');
  let materials = [];  // {name, number, factor}
  let markAll   = false;

  function renderRows(){
    if (!materials.length){
      rowsEl.innerHTML = `<tr><td colspan="5" style="text-align:center; opacity:.75">Este modelo no tiene materiales registrados.</td></tr>`;
      return;
    }
    rowsEl.innerHTML = materials.map((m,idx)=>`
      <tr data-idx="${idx}">
        <td>${m.name||''}</td>
        <td>${m.number||''}</td>
        <td class="num">${Number(m.factor||0)}</td>
        <td class="num"><span class="qty" data-raw="0">0</span></td>
        <td class="num"><input type="checkbox" class="chk-ask"></td>
      </tr>
    `).join('');
    updateQuantities();
  }

  function updateQuantities(){
    const base = Math.max(0, Number(qtyEl.value||0));
    qsa('#rows tr').forEach(tr=>{
      const i = Number(tr.dataset.idx||0);
      const f = Number(materials[i]?.factor||0);
      const tot = base * f;
      const cell = tr.querySelector('.qty');
      if (cell){ cell.dataset.raw = String(tot); cell.textContent = nf(tot); }
    });
  }

  function toggleAll(){ markAll = !markAll; qsa('.chk-ask').forEach(c=> c.checked = markAll); }

  // ---- Suscripciones en tiempo real al MODELO ----
  const refNew = doc(db, 'KB', params.kb, 'lines', params.line, 'models', params.id);
  const refOld = doc(db, 'lines', params.line, 'models', params.id);
  let unsubSubMaterials = null;

  function listenSubMaterials(docRef){
    if (unsubSubMaterials) { try{unsubSubMaterials()}catch{}; unsubSubMaterials=null; }
    const colRef = collection(docRef, 'materials');
    unsubSubMaterials = colSnapshot(query(colRef, orderBy('name','asc')), snap=>{
      materials = snap.docs.map(d=>{ const m=d.data()||{}; return {name:m.name||'', number:m.number||'', factor:Number(m.factor||0)}; });
      renderRows();
    });
  }

  function handleModelSnapshot(snap, pathArr){
    if (!snap.exists()) return;
    const data = snap.data() || {};
    titleEl.textContent = (data.name || data.display || 'MODELO').toUpperCase();

    if (Array.isArray(data.materials) && data.materials.length){
      materials = data.materials.map(m=>({ name:m.name||'', number:m.number||'', factor:Number(m.factor||0) }));
      renderRows();
    } else {
      listenSubMaterials(doc(db, ...pathArr));
    }
  }

  onSnapshot(refNew, snap => handleModelSnapshot(snap, ['KB', params.kb, 'lines', params.line, 'models', params.id]));
  onSnapshot(refOld, snap => handleModelSnapshot(snap, ['lines', params.line, 'models', params.id]));

  // ---- EnvÃ­o a 311 (por sesiÃ³n) ----
  function isKanbanName(name=''){ const n=name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); return /\bbase\b/.test(n)||/\btapa\b/.test(n); }
  async function sendTo311(){
    const base = Math.max(0, Number(qtyEl.value||0));
    if (!base){ alert('Ingresa una cantidad mayor a 0.'); return; }

    // ðŸ”´ Asegurar creaciÃ³n del doc padre users/{sessionId}
    const userDocRef = doc(db, 'KB', params.kb, 'lines', params.line, 'users', sessionId);
    await setDoc(userDocRef, { active:true, updatedAt: serverTimestamp() }, { merge:true });

    const ops=[];
    qsa('#rows tr').forEach(tr=>{
      const chk=tr.querySelector('.chk-ask'); if (!chk?.checked) return;
      const i = Number(tr.dataset.idx||0);
      const add = Number(tr.querySelector('.qty')?.dataset.raw||0);
      const part = (materials[i]?.number||'').trim();
      const name = materials[i]?.name||'';
      if (!part || add<=0) return;

      const kind = isKanbanName(name) ? 'kanbanCart' : 'cart';
      const ref = doc(db, 'KB', params.kb, 'lines', params.line, 'users', sessionId, kind, part);
      ops.push(setDoc(ref, { number: part, qty: increment(add) }, { merge:true }));
    });
    if (ops.length) await Promise.all(ops);
    alert('Material agregado a 311.');
  }

  qs('#btnBack').onclick   = () => history.length>1 ? history.back() : (location.href='index.html');
  qs('#btnEdit').onclick   = () => location.href = `nuevomodelo.html?mode=edit&kb=${params.kb}&line=${params.line}&id=${params.id}`;
  qs('#btnToggleAll').onclick = toggleAll;
  qs('#btnOk').onclick     = sendTo311;
  qs('#qtyInput').addEventListener('input', updateQuantities);
</script>
</body>
</html>
