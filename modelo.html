<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modelo</title>
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./style-modelos.css" />
  <style>
    .tabla { width: min(100%, 980px); margin: 20px auto; border-collapse: collapse; }
    .tabla th, .tabla td { border:1px solid rgba(0,0,0,.35); padding:10px 12px; background: rgba(255,255,255,0.08); }
    .tabla thead th { background: rgba(255,255,255,0.18); }
    .controls { display:flex; gap:16px; align-items:center; justify-content:center; margin: 16px auto; }
    .qty{
      width: 9ch; min-width: 9ch; padding:10px 14px; border:2px solid #000; border-radius:6px;
      background:#fff; color:#000; font-weight:700; text-align:center;
      font-variant-numeric: tabular-nums; font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .right-actions { display:flex; gap:18px; justify-content:center; margin: 20px auto; }
    #editor[hidden] { display:none !important; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <a class="logo" href="./index.html" title="Ir al inicio">
      <img src="./img/logo.png" alt="Logo">
    </a>
    <h1 class="title">MATERIALISTAS PAGE</h1>
    <button class="btn-agregar" id="backBtn" type="button">VOLVER</button>
  </header>

  <!-- TÃ­tulo del modelo (modo lectura) -->
  <h2 id="titulo" class="detalle-titulo">(NOMBRE DEL MODELO)</h2>

  <!-- ======= MODO LECTURA ======= -->
  <section id="viewer">
    <div class="controls">
      <label class="chip">
        <span>INGRESA CANTIDAD</span>
        <input class="qty" id="qtyInput" type="text" inputmode="numeric" pattern="\d{1,5}" maxlength="5" placeholder="00000" size="6" />
      </label>
      <button class="btn btn-compact" id="marcarTodo">MARCAR TODO</button>
    </div>

    <table class="tabla" id="tbl">
      <thead>
        <tr>
          <th>MATERIAL</th>
          <th>NÃšMERO DE PARTE</th>
          <th>FACTOR</th>
          <th>CANTIDAD</th>
          <th>TENGO</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="right-actions">
      <button class="btn" id="editar">EDITAR MODELO</button>
      <button class="btn" id="okBtn">OK</button>
    </div>
  </section>

  <!-- ======= MODO EDICIÃ“N ======= -->
  <section id="editor" class="wrap" hidden>
    <div class="form-wrap">
      <h2 class="detalle-titulo">EDITAR MODELO</h2>

      <!-- Nombre del modelo -->
      <div class="row">
        <label class="lbl" for="editName">NOMBRE DEL MODELO</label>
        <input id="editName" class="txt" placeholder="Ej. 805000340101" />
      </div>

      <!-- Filas de materiales -->
      <div class="materials-wrap" id="materialsWrap"></div>

      <div class="row end">
        <button class="btn-secondary" id="addMat" type="button">AGREGAR MATERIAL</button>
      </div>

      <div class="right-actions">
        <button class="btn" id="cancelEdit" type="button">CANCELAR</button>
        <button class="btn" id="saveEdit" type="button">GUARDAR</button>
      </div>
    </div>
  </section>

  <script type="module" src="./firebase-config.js"></script>
  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      doc, getDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ParÃ¡metros
    const p = new URLSearchParams(location.search);
    const KB   = p.get("kb");
    const LINE = p.get("line");
    const ID   = p.get("id");

    // ðŸ”™ VOLVER determinÃ­stico
    document.getElementById("backBtn").onclick = () => {
      if (KB && LINE) {
        location.href = `./${KB}/lineas/${LINE.toLowerCase()}.html`;
      } else {
        location.href = "./index.html";
      }
    };

    // ðŸ”‘ Carrito 311 por KB y LÃ­nea
    const CART_KEY = `mp311_${KB}_${LINE}`;

    // DOM (lectura)
    const titulo   = document.getElementById("titulo");
    const qtyInput = document.getElementById("qtyInput");
    const tbody    = document.querySelector("#tbl tbody");
    const marcarTodoBtn = document.getElementById("marcarTodo");
    const okBtn    = document.getElementById("okBtn");
    const editarBtn= document.getElementById("editar");

    const viewer   = document.getElementById("viewer");
    const editor   = document.getElementById("editor");

    // DOM (ediciÃ³n)
    const editName = document.getElementById("editName");
    const materialsWrap = document.getElementById("materialsWrap");
    const addMatBtn = document.getElementById("addMat");
    const cancelEditBtn = document.getElementById("cancelEdit");
    const saveEditBtn   = document.getElementById("saveEdit");

    // Estado del modelo
    const ref  = doc(db, "KB", KB, "lines", LINE, "models", ID);
    const snap = await getDoc(ref);
    if (!snap.exists()) { alert("Modelo no encontrado"); location.href = `./index.html`; throw new Error("No model"); }
    let model = snap.data();

    titulo.textContent = model.name || model.display || "(Modelo)";
    let materials = (model.materials || []).map(m => ({ ...m, tengo:false }));

    // ---------- MODO LECTURA ----------
    const calc = (factor, qty) => (Number(factor)||0) * (Number(qty)||0);

    function sanitizeAndGetQty() {
      const raw = (qtyInput.value || "").replace(/\D/g, "").slice(0, 5);
      qtyInput.value = raw;
      return raw ? parseInt(raw, 10) : 0;
    }

    function renderViewer() {
      const qty = sanitizeAndGetQty();
      tbody.innerHTML = materials.map((m,i)=>`
        <tr>
          <td>${m.name}</td>
          <td>${m.number}</td>
          <td style="text-align:center">${m.factor}</td>
          <td style="text-align:center">${calc(m.factor, qty)}</td>
          <td style="text-align:center"><input type="checkbox" data-i="${i}" ${m.tengo?"checked":""}/></td>
        </tr>
      `).join("");

      tbody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.onchange = ()=> { materials[+cb.dataset.i].tengo = cb.checked; };
      });
    }

    qtyInput.addEventListener("input", renderViewer);
    marcarTodoBtn.onclick = ()=>{
      const all = materials.every(m=>m.tengo);
      materials.forEach(m=> m.tengo = !all);
      renderViewer();
    };

    okBtn.onclick = ()=>{
      const qty = sanitizeAndGetQty();
      if (!qty || qty <= 0) {
        alert("Ingresa una cantidad mayor a 0.");
        return;
      }
      const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
      materials.filter(m=>!m.tengo).forEach(m=>{
        const add = (Number(m.factor)||0) * qty;
        if (!add) return;
        cart[m.number] = (cart[m.number] || 0) + add;
      });
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      // recuerda el Ãºltimo contexto para 311
      localStorage.setItem("mp311_last", JSON.stringify({ kb: KB, line: LINE }));
      // volver a la lÃ­nea
      location.href = `./${KB}/lineas/${LINE.toLowerCase()}.html`;
    };

    // ---------- MODO EDICIÃ“N ----------
    function createMatRow(data = {name:"", number:"", factor:""}) {
      const row = document.createElement("div");
      row.className = "mat-row";
      row.innerHTML = `
        <input class="txt mat-name"   placeholder="NOMBRE DEL MATERIAL" value="${(data.name||"").replace(/"/g,'&quot;')}"/>
        <input class="txt mat-number" placeholder="NÃšMERO DEL MATERIAL" value="${(data.number||"").replace(/"/g,'&quot;')}"/>
        <div class="mat-factor">
          <span class="hint">Se multiplica porâ€¦ Â¿?</span>
          <input class="txt mat-factor-input" inputmode="numeric" pattern="\\d+" placeholder="NUMERO (factor)" value="${data.factor ?? ""}"/>
        </div>
        <button class="btn-x" type="button" title="Eliminar material">âœ•</button>
      `;
      row.querySelector(".btn-x").onclick = () => row.remove();
      return row;
    }

    function loadEditorFromModel() {
      editName.value = model.name || model.display || "";
      materialsWrap.innerHTML = "";
      (model.materials || []).forEach(m => materialsWrap.appendChild(createMatRow(m)));
      if ((model.materials || []).length === 0) {
        materialsWrap.appendChild(createMatRow());
      }
    }

    function showEditor(show) {
      viewer.hidden = !!show;
      editor.hidden = !show;
    }

    editarBtn.onclick = () => {
      loadEditorFromModel();
      showEditor(true);
      window.scrollTo({top:0, behavior:"smooth"});
    };

    addMatBtn.onclick = () => materialsWrap.appendChild(createMatRow());
    cancelEditBtn.onclick = () => showEditor(false);

    async function saveEditor() {
      const name = editName.value.trim();
      const rows = Array.from(materialsWrap.querySelectorAll(".mat-row"));
      const newMaterials = rows.map(r => ({
        name:   r.querySelector(".mat-name").value.trim(),
        number: r.querySelector(".mat-number").value.trim(),
        factor: parseInt((r.querySelector(".mat-factor-input").value || "0").replace(/\D/g,""), 10) || 0
      }));

      if (!name) { alert("Ingresa el NOMBRE DEL MODELO."); return; }
      if (!newMaterials.length) { alert("Agrega al menos un material."); return; }
      for (const m of newMaterials) {
        if (!m.name || !m.number) { alert("Cada material debe tener NOMBRE y NÃšMERO."); return; }
        if (!(m.factor > 0)) { alert("El FACTOR debe ser un nÃºmero mayor a 0."); return; }
      }

      try {
        await updateDoc(ref, { name, display: name, materials: newMaterials, updatedAt: serverTimestamp() });
        model.name = name; model.display = name; model.materials = newMaterials;
        titulo.textContent = name;
        materials = newMaterials.map(m => ({ ...m, tengo:false }));
        showEditor(false);
        renderViewer();
        alert("Modelo actualizado.");
      } catch (err) {
        console.error(err);
        alert("No se pudo guardar. Revisa tu conexiÃ³n o permisos.");
      }
    }

    saveEditBtn.onclick = saveEditor;

    // Abrir editor directo con ?edit=1
    if (p.get("edit") === "1") { loadEditorFromModel(); showEditor(true); window.scrollTo({top:0, behavior:"smooth"}); }

    // Render inicial
    renderViewer();
  </script>
</body>
</html>
